# ZenithJoy Engine 完整开发流程（v10.6.0）

## 流程总览

```
PRD → /dev → 写代码 → 质检 → PR → CI → 合并
       │                │      │    │
       │                │      │    └─ 远端强制检查
       │                │      └───── 本地 Hook 拦截
       │                └─────────── 本地质检循环
       └───────────────────────────── 流程编排
```

---

## 阶段 1: PRD 到分支创建

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1-3: PRD → 环境检测 → 分支创建                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 用户需求 → /dev 开始                                        │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 阶段检测: bash scripts/detect-phase.sh              │   │
│ │   → PHASE: p0 (无 PR，需要创建)                     │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ Step 1: PRD 确定 (01-prd.md)                                │
│   - 用户提供需求或 PRD 文件                                 │
│   - 创建 .prd.md                                            │
│                                                             │
│ Step 2: 环境检测 (02-detect.md)                             │
│   - 检测当前分支                                            │
│   - 检测是否在 worktree                                     │
│                                                             │
│ Step 3: 分支创建 (03-branch.md)                             │
│   - 从 develop 创建 cp-MMDDTTTT-xxx 分支                    │
│   - 分支名规则：cp-月日时分-简短描述                        │
│                                                             │
│ 产物:                                                       │
│   - .prd.md                                                 │
│   - 新分支：cp-01251900-feature-name                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 2: DoD 定稿（含 QA Decision Node）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 4: DoD 定稿 + QA Decision                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ QA Decision Node (skills/qa/SKILL.md)               │   │
│ │                                                      │   │
│ │ 判断：                                               │   │
│ │   - 这个改动需要什么测试？                           │   │
│ │   - 要不要进 regression-contract.yaml？              │   │
│ │   - 要不要进 Golden Path？                           │   │
│ │                                                      │   │
│ │ 输出: docs/QA-DECISION.md                            │   │
│ │   Decision: NO_RCI | MUST_ADD_RCI | UPDATE_RCI      │   │
│ │   Priority: P0 | P1 | P2                            │   │
│ │   Tests: [{dod_item, method, location}]             │   │
│ │   RCI: {new: [], update: []}                        │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 基于 QA Decision 创建 DoD:                                  │
│   - 功能验收清单                                            │
│   - 每个条目对应测试方法（Test: 字段）                      │
│   - Test: tests/xxx.test.ts                                │
│   - Test: contract:H2-001                                  │
│   - Test: manual:描述                                      │
│                                                             │
│ 产物:                                                       │
│   - docs/QA-DECISION.md                                     │
│   - .dod.md                                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 3: 写代码 + 写测试

```
┌─────────────────────────────────────────────────────────────┐
│ Step 5-6: 写代码 + 写测试                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Step 5: 写代码 (05-code.md)                                 │
│   - 根据 PRD 和 DoD 实现功能                                │
│   - 遵循代码规范                                            │
│   - 更新相关文档                                            │
│                                                             │
│ Step 6: 写测试 (06-test.md)                                 │
│   - 根据 QA-DECISION.md 中的 Tests 字段                     │
│   - 创建/更新测试文件                                       │
│   - 确保 DoD 每个条目都有对应测试                           │
│                                                             │
│ 产物:                                                       │
│   - 代码文件                                                │
│   - 测试文件（tests/*.test.ts）                             │
│   - 更新 regression-contract.yaml（如果需要）               │
│   - 更新 features/feature-registry.yml（如果核心能力变更）  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 4: 质检循环（Stop Hook 强制）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 7: 质检循环（本地，Stop Hook 强制）                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Audit Node (skills/audit/SKILL.md)                  │   │
│ │                                                      │   │
│ │ 代码审计（分层标准）：                               │   │
│ │   L1 (阻塞性): 必须修                                │   │
│ │   L2 (功能性): 建议修                                │   │
│ │   L3 (最佳实践): 可选                                │   │
│ │   L4 (过度优化): 不修                                │   │
│ │                                                      │   │
│ │ 输出: docs/AUDIT-REPORT.md                           │   │
│ │   Decision: PASS | FAIL                             │   │
│ │   Findings: [{id, layer, file, issue, fix, status}] │   │
│ │   Blockers: []  # L1 + L2 问题列表                  │   │
│ │                                                      │   │
│ │ 目标: L1=0 AND L2=0 → Decision: PASS                │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ L1 测试: npm run qa:gate                            │   │
│ │                                                      │   │
│ │ 执行:                                                │   │
│ │   1. npm run typecheck       ─┐                     │   │
│ │   2. npm run test             ├─ 全跑一遍           │   │
│ │   3. npm run build           ─┘                     │   │
│ │                                                      │   │
│ │ 生成产物:                                            │   │
│ │   - .quality-gate-passed (时间戳 + commit)          │   │
│ │   - .quality-evidence.json                          │   │
│ │       {                                              │   │
│ │         sha: "当前 HEAD",                            │   │
│ │         branch: "cp-xxx",                            │   │
│ │         qa_gate_passed: true,                        │   │
│ │         audit_decision: "PASS",                      │   │
│ │         timestamp: "..."                             │   │
│ │       }                                              │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 手动创建: .layer2-evidence.md                       │   │
│ │                                                      │   │
│ │ 记录可复核证据：                                     │   │
│ │   ## 手动验证                                        │   │
│ │   - [x] 运行 xxx 命令成功                            │   │
│ │   - [x] curl 返回 200                                │   │
│ │                                                      │   │
│ │   ## 自动化测试                                      │   │
│ │   - 191/191 tests passed                             │   │
│ │                                                      │   │
│ │   ## 代码审计                                        │   │
│ │   - AUDIT-REPORT.md: Decision PASS                   │   │
│ │                                                      │   │
│ │   ## 截图（如有 UI 改动）                            │   │
│ │   - screenshots/feature-x.png                        │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ 质检循环逻辑：                                              │
│   - Audit FAIL → 修复 → 重新审计                           │
│   - L1 FAIL → 修复 → 重跑 npm run qa:gate                  │
│   - 全部 PASS → 继续下一步                                 │
│                                                             │
│ Stop Hook 强制：                                            │
│   - 会话结束时检查:                                         │
│     * docs/AUDIT-REPORT.md 存在 + Decision: PASS           │
│     * .quality-gate-passed 存在                            │
│   - 不满足 → exit 2 (继续会话，不允许结束)                 │
│                                                             │
│ 产物:                                                       │
│   - docs/AUDIT-REPORT.md (Decision: PASS)                   │
│   - .quality-gate-passed                                    │
│   - .quality-evidence.json                                  │
│   - .layer2-evidence.md                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 5: 提交 PR（本地 Hook 拦截）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 8: 提交 PR（本地 Hook 门控）                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ git add . && git commit -m "feat: xxx"                      │
│ git push origin cp-xxx                                      │
│ gh pr create --base develop --title "feat: xxx"             │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Hook: hooks/pr-gate-v2.sh (PreToolUse:Bash)         │   │
│ │       拦截 "gh pr create" 命令                       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Part 0.5: CI Preflight（智能跳过，< 1s）            │   │
│ │                                                      │   │
│ │ bash scripts/devgate/ci-preflight.sh                 │   │
│ │   1. 检查 .quality-gate-passed 是否存在             │   │
│ │   2. 检查文件是否新鲜（< 5 分钟）                    │   │
│ │   3. 验证 SHA 是否匹配当前 HEAD                      │   │
│ │                                                      │   │
│ │ 新鲜且 SHA 匹配 → exit 0（通过，不重跑测试）        │   │
│ │ 过期或不存在 → exit 1（失败，提示运行 qa:gate）     │   │
│ │                                                      │   │
│ │ 注意：不再重跑 typecheck/test，只检查证据有效性     │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Part 1: L1 自动化测试                               │   │
│ │                                                      │   │
│ │   1. npm run typecheck       ─┐                     │   │
│ │   2. npm run test             ├─ 再次重复跑！[重复点2]│
│ │   3. npm run build           ─┘                     │   │
│ │                                                      │   │
│ │ timeout: 120s                                        │   │
│ │ 失败 → FAILED=1，阻止 PR                             │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Part 2: L2A 产物检查                                │   │
│ │                                                      │   │
│ │   - .prd.md 存在                                     │   │
│ │   - .dod.md 存在                                     │   │
│ │   - docs/QA-DECISION.md 存在                         │   │
│ │   - docs/AUDIT-REPORT.md 存在 + Decision: PASS       │   │
│ │   - .quality-gate-passed 存在                        │   │
│ │                                                      │   │
│ │ 失败 → FAILED=1，阻止 PR                             │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Part 2.5: L2B-min 证据检查                          │   │
│ │                                                      │   │
│ │ bash scripts/devgate/l2b-check.sh pr                 │   │
│ │   - .layer2-evidence.md 存在                         │   │
│ │   - 必需章节齐全（手动验证、自动化测试）             │   │
│ │   - 至少 1 条可复核证据                              │   │
│ │                                                      │   │
│ │ 失败 → FAILED=1，阻止 PR                             │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ Release 模式额外检查（PR to main）:                         │
│   - L2B-full: DoD 全部勾选                                 │
│   - L3: 回归测试全量                                       │
│                                                             │
│ Hook 判断:                                                  │
│   - FAILED=0 → exit 0 (放行，PR 创建成功)                   │
│   - FAILED=1 → exit 2 (阻止，提示修复)                      │
│                                                             │
│ p0 阶段结束:                                                │
│   - PR 创建成功后，Stop Hook 允许会话结束                   │
│   - 不等待 CI，直接结束对话                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 6: CI 远端检查（GitHub Actions）

```
┌─────────────────────────────────────────────────────────────┐
│ CI 流程（GitHub Actions）                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ PR 创建/更新 → 触发 pull_request 事件                       │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 1: version-check                                │   │
│ │   检查 package.json version 是否更新                 │   │
│ │   BASE_VERSION ≠ CURRENT_VERSION                     │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 2: contract-drift-check                         │   │
│ │   检查 feature-registry.yml 改动 →                  │   │
│ │   派生视图必须同步更新                               │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 3: test (核心质检)                              │   │
│ │                                                      │   │
│ │ L1 自动化测试:                                       │   │
│ │   1. npm run typecheck       ─┐                     │   │
│ │   2. npm run test             ├─ 第三次重复跑！[重复点3]│
│ │   3. npm run build           ─┘                     │   │
│ │                                                      │   │
│ │ DevGate 三合一检查:                                  │   │
│ │   1. DoD 映射检查（check-dod-mapping.cjs）           │   │
│ │      每个 DoD 条目 → 对应测试文件存在                │   │
│ │                                                      │   │
│ │   2. P0/P1 RCI 更新检查                              │   │
│ │      (require-rci-update-if-p0p1.sh)                 │   │
│ │      PR title 含 P0/P1 →                            │   │
│ │      regression-contract.yaml 必须更新               │   │
│ │                                                      │   │
│ │   3. RCI 覆盖率检查（scan-rci-coverage.cjs）         │   │
│ │      新增业务入口 → 必须有对应 RCI                   │   │
│ │                                                      │   │
│ │ Shell 脚本语法检查:                                  │   │
│ │   bash -n scripts/**/*.sh hooks/*.sh                 │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 4: evidence-gate (质检证据验证)                 │   │
│ │                                                      │   │
│ │ 检查 .quality-evidence.json:                         │   │
│ │   1. 文件存在                                        │   │
│ │   2. JSON 格式有效                                   │   │
│ │   3. 必需字段齐全                                    │   │
│ │   4. SHA 匹配 HEAD~1 (防老文件冒用) ⚠️ 关键         │   │
│ │   5. qa_gate_passed == true                          │   │
│ │   6. audit_decision == "PASS"                        │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 5: impact-check (能力变更强制登记)              │   │
│ │                                                      │   │
│ │ 检查核心文件改动 →                                   │   │
│ │ feature-registry.yml 必须同时更新                    │   │
│ │                                                      │   │
│ │ 核心文件: hooks/, skills/, scripts/devgate/, docs/  │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 6: l2b-check (L2B 证据检查)                     │   │
│ │                                                      │   │
│ │ PR to develop: L2B-min                               │   │
│ │   bash scripts/devgate/l2b-check.sh pr               │   │
│ │   - .layer2-evidence.md 存在                         │   │
│ │   - 必需章节齐全                                     │   │
│ │   - 至少 1 条可复核证据                              │   │
│ │                                                      │   │
│ │ PR to main: L2B-full (在 release-check 检查)         │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 7: regression-pr (回归测试)                     │   │
│ │                                                      │   │
│ │ bash scripts/rc-filter.sh pr                         │   │
│ │ 跑 trigger=[PR] 的 RCI                               │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 8: release-check (仅 PR to main)                │   │
│ │                                                      │   │
│ │ L3 回归测试:                                         │   │
│ │   bash scripts/rc-filter.sh release                  │   │
│ │   跑 trigger=[Release] 的 RCI                        │   │
│ │                                                      │   │
│ │ L2B-full:                                            │   │
│ │   bash scripts/devgate/l2b-check.sh release          │   │
│ │   - DoD 全部勾选                                     │   │
│ │   - 完整证据                                         │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 9: ci-passed (门控汇总)                         │   │
│ │                                                      │   │
│ │ needs: [version-check, test, contract-drift-check,   │   │
│ │        evidence-gate, impact-check, l2b-check,       │   │
│ │        regression-pr, release-check]                 │   │
│ │                                                      │   │
│ │ 全部 success 或 skipped → ci-passed 成功             │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 10: ai-review (L2C 语义审查) - ⚠️ Disabled     │   │
│ │                                                      │   │
│ │ needs: [ci-passed]                                   │   │
│ │ continue-on-error: true (不阻断 PR)                  │   │
│ │                                                      │   │
│ │ 状态: VPS_REVIEW_URL 未配置，每次跳过                │   │
│ │                                                      │   │
│ │ 原本功能:                                            │   │
│ │   1. 提取 PR diff                                    │   │
│ │   2. 调用 VPS Review API                             │   │
│ │   3. 在 PR 下评论语义风险建议                        │   │
│ │                                                      │   │
│ │ 当前行为: 检查 VPS_REVIEW_URL → 未配置 → 跳过       │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Job 11: notify-failure (失败通知)                   │   │
│ │   仅在其他 job 失败时运行                            │   │
│ │   记录失败信息（可扩展为 Slack/Email 通知）          │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 7: p1 修复循环（CI 失败时）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 9: CI 修复循环（p1 阶段）                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 阶段检测: bash scripts/detect-phase.sh              │   │
│ │   → PHASE: p1 (PR 存在 + CI fail)                   │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ while true; do                                              │
│   检查 CI 状态 (gh api)                                     │
│                                                             │
│   case CI 状态:                                             │
│     in_progress/queued/pending:                             │
│       sleep 30s                                             │
│       continue（继续循环）                                  │
│                                                             │
│     failure:                                                │
│       1. 分析失败原因（读取 job logs）                      │
│       2. 修复代码                                           │
│       3. 重新质检:                                          │
│          - npm run qa:gate (如果代码改了)                   │
│          - 更新 .layer2-evidence.md (如果需要)              │
│       4. git add && commit && push                          │
│       5. continue（继续循环，不退出！）                     │
│                                                             │
│     success:                                                │
│       gh pr merge --squash --delete-branch                  │
│       break（退出循环）                                     │
│ done                                                        │
│                                                             │
│ 结束对话 ✅                                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 阶段 8: 完成后清理（可选）

```
┌─────────────────────────────────────────────────────────────┐
│ Step 10-11: Learning + Cleanup                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ Step 10: Learning (可选)                                    │
│   - 记录开发过程中的经验教训                                │
│   - 追加到 docs/LEARNINGS.md                                │
│                                                             │
│ Step 11: Cleanup                                            │
│   - 切换回 develop 分支                                     │
│   - 删除本地工作分支（远端已删）                            │
│   - 删除运行时文件:                                         │
│     * .prd.md                                               │
│     * .dod.md                                               │
│     * .quality-gate-passed                                  │
│     * .layer2-evidence.md                                   │
│   - 运行完成度检查:                                         │
│     bash skills/dev/scripts/check.sh                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔴 重复点分析

### [重复点 1] Preflight 与 qa:gate 重复 - ✅ 已优化

**位置**: Hook Part 0.5 vs Step 7

**原来的问题**:
```
ci-preflight.sh（旧）:
  - typecheck          ← 重复跑
  - test               ← 重复跑
  - l3-fast            ← 假检查（已删除）
  - 检查 PRD/DoD 存在

qa:gate:
  - typecheck
  - test
  - build
  - 生成证据文件
```

**优化方案**: ✅ 已实施智能跳过

```
ci-preflight.sh（新）:
  1. 检查 .quality-gate-passed 是否新鲜（< 5 分钟）
  2. 验证 SHA 是否匹配当前 HEAD
  3. 新鲜且匹配 → exit 0（通过，不重跑测试）
  4. 过期或不存在 → exit 1（提示运行 qa:gate）
```

**效果**:
- 刚跑完 qa:gate 后立即 PR → Preflight 跳过（< 1s）
- Hook 检查从 2 分钟降到 0.5 分钟（75% 提升）
- 认知清晰：只有 qa:gate 跑测试（唯一权威）

---

### [重复点 2] Hook Part 1 与 qa:gate 重复

**位置**: Hook Part 1 (L1) vs Step 7

```
Hook Part 1:
  - typecheck
  - test
  - build

qa:gate:
  - typecheck
  - test
  - build
```

**重复内容**: 全部

**原因**:
- Hook 是"最后防线"（防止绕过 qa:gate 直接 PR）
- qa:gate 是"本地质检"（正常流程）

**是否合理**: ✅ **合理且必要**

**理由**:
1. **防绕过**: 用户可能忘记/跳过 qa:gate
2. **最终验证**: 即使跑过 qa:gate，代码可能又改了
3. **本地强制**: Hook 是本地最后一道门，必须再验证一次

---

### [重复点 3] CI test job 与本地测试重复

**位置**: CI test job vs 本地 qa:gate + Hook

```
CI test job:
  - typecheck
  - test
  - build

本地已跑:
  - qa:gate (typecheck/test/build)
  - Hook Part 1 (typecheck/test/build)
```

**重复内容**: 全部

**原因**:
- CI 是"远端强制"（最终兜底）
- 本地 Hook 可能被禁用（用户修改 settings.json）

**是否合理**: ✅ **合理且必要**

**理由**:
1. **远端兜底**: 本地 Hook 可以绕过（删除 .claude/settings.json）
2. **环境差异**: 本地可能有环境问题，CI 是干净环境
3. **Branch Protection**: GitHub 强制要求 CI 通过才能合并

---

## 总结：重复点评估

| 重复点 | 位置 | 是否合理 | 状态 |
|--------|------|----------|------|
| **Preflight vs qa:gate** | Hook Part 0.5 vs Step 7 | ❌ 可优化 | ✅ 已优化（智能跳过） |
| **Hook vs qa:gate** | Hook Part 1 vs Step 7 | ✅ 必要 | ✅ 保持（防绕过） |
| **CI vs 本地** | CI test job vs 本地 | ✅ 必要 | ✅ 保持（远端兜底） |

---

## 流程优化记录

### ✅ 优化 1: Preflight 智能跳过（已实施）

**实施时间**: v10.6.0 → v10.7.0

**改动**:
- 删除 L3-fast 脚本（空盒子，认知污染源）
- 移除 package.json 中的 lint/format 占位符
- 重写 ci-preflight.sh 为智能跳过逻辑

**新逻辑**:
```bash
# scripts/devgate/ci-preflight.sh

# 1. 检查 .quality-gate-passed 是否存在且新鲜（< 5 分钟）
# 2. 验证 SHA 是否匹配当前 HEAD
# 3. 新鲜且匹配 → exit 0（通过）
# 4. 过期或不存在 → exit 1（提示运行 qa:gate）
```

**效果**:
- ✅ Hook 检查从 2 分钟降到 0.5 分钟（75% 提升）
- ✅ 认知清晰：只有 qa:gate 跑测试（唯一权威）
- ✅ 移除认知污染源（L3-fast、AI Review 标注 Disabled）

---

### 优化 2: qa:gate 输出缓存

当前 qa:gate 每次都重新跑全部测试。可以增加增量检测：

```bash
# 检查自上次 qa:gate 以来是否有代码改动
LAST_GATE_SHA=$(grep "^# Commit:" .quality-gate-passed | awk '{print $3}')
CURRENT_SHA=$(git rev-parse --short HEAD)

if [ "$LAST_GATE_SHA" = "$CURRENT_SHA" ]; then
  echo "✅ 代码未改动，质检结果仍然有效"
  exit 0
fi
```

**注意**: 这个优化要小心，可能导致漏检。建议只在 Preflight 用。

---

## 完整流程时间估算

| 阶段 | 耗时 | 说明 |
|------|------|------|
| Step 1-4 (PRD → DoD) | 5-10 分钟 | 用户交互 + AI 生成 |
| Step 5-6 (写代码 + 测试) | 30-120 分钟 | 取决于功能复杂度 |
| Step 7 (质检循环) | 5-10 分钟 | Audit + qa:gate + 创建证据 |
| Step 8 (PR 创建) | 1-2 分钟 | Hook 检查 + 推送 |
| CI 运行 | 3-5 分钟 | 11 个 jobs 并行跑 |
| p1 修复（如需要） | 10-30 分钟 | 取决于失败原因 |
| **总计** | **1-3 小时** | 不含写代码时间 |

---

**关键时间节点** (v10.7.0 优化后):
1. **qa:gate**: ~2 分钟（typecheck + test + build）
2. **Hook 检查**: ~30 秒（✅ Preflight 智能跳过 + Hook Part 1-2.5）
3. **CI**: ~3-5 分钟（并行 jobs）

**优化效果**:
- ✅ Hook 检查从 2 分钟降到 30 秒（75% 提升）
- ✅ 总流程时间从 7 分钟降到 5.5 分钟
