# PRD: Main 分支保护加强

## 背景

发现安全漏洞：可以绕过 /dev 工作流直接合并到 main。

### 漏洞复现步骤
```bash
git checkout -b cp-xxx main
git checkout origin/develop -- .  # 复制代码，不触发 hooks
echo "伪造的 DoD" > .dod.md
git push && gh pr create --base main
# CI 通过，直接合并
```

### 根本原因
1. `branch-protect.sh` 只在 Claude Code 的 Edit/Write 时触发
2. `git checkout` 是原生 git 命令，不触发 hooks
3. `release-check.sh` 只检查文件存在和格式，不验证来源
4. CI 没有强制检查 Gate 签名文件

## 功能描述

### 方案：CI 强制检查 PR 来源

在 CI 中添加检查：
- **PR to main**：只接受来自 develop 分支的 PR
- **PR to develop**：接受来自 cp-* 或 feature/* 分支的 PR

### 实现

修改 `.github/workflows/ci.yml`：

```yaml
release-check:
  if: github.base_ref == 'main'
  steps:
    - name: Check PR source branch
      run: |
        if [[ "${{ github.head_ref }}" != "develop" ]]; then
          echo "❌ PR to main 只能来自 develop 分支"
          echo "   当前来源: ${{ github.head_ref }}"
          exit 1
        fi
```

## 成功标准

1. [ ] PR to main 只接受 develop 分支
2. [ ] 尝试从 cp-* 直接 PR 到 main 会被 CI 拒绝
3. [ ] 正常的 develop → main release 流程不受影响

## 优先级

P0 - 安全漏洞
