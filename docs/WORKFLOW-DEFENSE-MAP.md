---
id: workflow-defense-map
version: 1.1.0
created: 2026-01-24
updated: 2026-01-24
changelog:
  - 1.1.0: 添加风险接受声明（基于官方 Hook 文档验证）
  - 1.0.0: 完整工作流防护能力地图
---

# 工作流防护能力地图

**完整 /dev 工作流，每一步标注防护能力**

---

## 完整流程图

```
┌──────────────────────────────────────────────────────────────┐
│  /dev 工作流 - 11 个步骤                                      │
└──────────────────────────────────────────────────────────────┘

Step 1: PRD 确定
    ├─ 工具: Write (.prd.md)
    ├─ Hook: PreToolUse (Write)
    ├─ 检查: 分支必须是 cp-* 或 feature/*
    └─ 防护: ✅ 100% (唯一路径)
         ↓
Step 2: 环境检测
    ├─ 工具: Bash (git status)
    ├─ Hook: 无
    └─ 防护: ❌ 0% (只是检查，不强制)
         ↓
Step 3: 分支创建/切换
    ├─ 工具: Bash (git checkout -b)
    ├─ Hook: 无
    └─ 防护: ❌ 0% (AI 自己决定)
         ↓
Step 4: DoD 定稿
    ├─ 工具: Write (.dod.md)
    ├─ Hook: PreToolUse (Write)
    ├─ 检查: PRD 必须存在
    └─ 防护: ✅ 100% (唯一路径)
         ↓
Step 5: 写代码
    ├─ 工具: Write/Edit (代码文件)
    ├─ Hook: PreToolUse (Write|Edit)
    ├─ 检查:
    │   ├─ 分支必须是 cp-* 或 feature/*
    │   ├─ PRD 必须存在且有效
    │   └─ DoD 必须存在且有效
    └─ 防护: ✅ 100% (唯一路径 - 但只防分支/PRD/DoD)
         ├─ ✅ 防止在 main/develop 写代码
         ├─ ✅ 防止没有 PRD/DoD 写代码
         └─ ❌ 无法防止写低质量代码
         ↓
Step 6: 写测试
    ├─ 工具: Write/Edit (测试文件)
    ├─ Hook: PreToolUse (Write|Edit)
    ├─ 检查: 同 Step 5（只检查分支/PRD/DoD）
    └─ 防护: ❌ 0% (Hook 无法强制写测试)
         ├─ ❌ Hook 不知道这是"测试文件"
         ├─ ❌ 无法检查是否写了测试
         ├─ ❌ 无法检查测试覆盖率
         └─ ❌ 无法检查测试质量
         ├─ 依赖: DoD 中列出测试要求（但 AI 可不勾选）
         └─ 依赖: CI 运行测试覆盖率检查
         ↓
Step 7: 质检 (npm run qa + /audit)
    ├─ 工具: Bash (npm run qa)
    ├─ Hook: 无强制
    ├─ AI 行为: 自己决定是否执行
    └─ 防护: ❌ 0% (AI 自觉)
         ├─ 问题 1: AI 可以跳过质检
         ├─ 问题 2: AI 可以判断"已有问题，不修复"
         └─ 问题 3: AI 可以敷衍写 AUDIT-REPORT.md
         ↓
Step 8: 提交 PR
    ├─ 工具: Bash (gh pr create)
    ├─ Hook: PreToolUse (Bash) → pr-gate-v2.sh
    ├─ 检查:
    │   ├─ npm run typecheck ✅
    │   ├─ npm run test ✅
    │   ├─ npm run build ✅
    │   ├─ PRD/DoD 存在 ✅
    │   ├─ QA-DECISION.md 存在 ✅
    │   └─ AUDIT-REPORT.md Decision: PASS ✅
    ├─ 防护: ⚠️ 60% (多路径)
    │   ├─ gh pr create → 100% 拦截
    │   ├─ gh api → 100% 拦截 (修复后)
    │   ├─ curl → 100% 拦截 (修复后)
    │   └─ Python/Node.js → 0% 拦截 (无法检测)
    └─ 绕过方式: AI 用其他语言调用 GitHub API
         ↓
Step 9: CI 运行
    ├─ 工具: GitHub Actions (服务器端)
    ├─ Hook: 无关 (不在本地)
    ├─ 检查:
    │   ├─ npm run typecheck ✅
    │   ├─ npm run test ✅
    │   ├─ npm run build ✅
    │   ├─ DevGate (DoD 映射、RCI) ✅
    │   └─ Shell 语法检查 ✅
    └─ 防护: ✅ 100% (服务器端，无法绕过)
         ↓
Step 10: 人工审核 (你 approve)
    ├─ 工具: GitHub Web UI
    ├─ Hook: 无关
    ├─ 检查: 你查看代码，决定是否 approve
    └─ 防护: ✅ 100% (A+ 强制要求)
         ↓
Step 11: 自动合并 / 手动合并
    ├─ 工具: GitHub Actions auto-merge 或 gh pr merge
    ├─ Hook: 无关
    ├─ 检查: A+ Branch Protection
    │   ├─ CI 必须通过 ✅
    │   ├─ 必须有 1 个 approve ✅
    │   └─ 无人可以直接 push ✅
    └─ 防护: ✅ 100% (服务器端，无法绕过)
```

---

## 防护能力总结

### ✅ 能 100% 防住的步骤

| 步骤 | 防护机制 | 防护范围 |
|------|---------|---------|
| Step 1: PRD 确定 | PreToolUse: Write | ✅ 必须有 PRD 文件 |
| Step 4: DoD 定稿 | PreToolUse: Write | ✅ 必须有 DoD 文件 |
| Step 5: 写代码 | PreToolUse: Write\|Edit | ✅ 必须在正确分支 + 有 PRD/DoD |
| Step 9: CI 运行 | GitHub Actions | ✅ 所有测试、构建、质检 |
| Step 10: 人工审核 | A+ Protection | ✅ 必须人工 approve |
| Step 11: 合并 | A+ Protection | ✅ 必须 CI 绿 + approved |

### ❌ 防不住的步骤

| 步骤 | 问题 | 原因 |
|------|------|------|
| Step 2: 环境检测 | AI 可跳过 | 只是检查，不强制 |
| Step 3: 分支创建 | AI 可跳过 | 只是建议，不强制 |
| **Step 6: 写测试** | **AI 可不写测试** | **Hook 无法检测是否写了测试** |
| **Step 7: 质检** | **AI 可跳过** | **多路径 + AI 自觉** |
| Step 8: 提交 PR | AI 可绕过 Hook | 多路径（可用其他语言）|

### ⚠️ 部分防护的步骤

| 步骤 | 防护程度 | 说明 |
|------|---------|------|
| Step 8: 提交 PR | 60% | gh pr create 被拦，但可用 Python/Node.js 绕过 |

---

## PostToolUse 能"反悔"拦截吗？

### PostToolUse 的特点

```
PreToolUse (工具执行前):
    ├─ 检查条件
    ├─ 不通过 → exit 2
    └─ 工具被阻止 ✅

PostToolUse (工具执行后):
    ├─ 工具已执行完成 (文件已写入)
    ├─ 检查结果
    └─ 不通过 → ???
```

### 能做什么？不能做什么？

| 能力 | PostToolUse 能做吗 | 说明 |
|------|------------------|------|
| **阻止操作** | ❌ 不能 | 工具已执行，文件已修改 |
| **撤销操作** | ❌ 不能 | Hook 无法强制撤销 |
| **提示警告** | ✅ 能 | 可以输出错误信息 |
| **记录日志** | ✅ 能 | 可以记录到文件 |
| **要求 AI 手动撤销** | ⚠️ 部分 | 可以提示，但无法强制 |

### 示例：PostToolUse 检查代码质量

```bash
# hooks/post-write-check.sh (假设的 PostToolUse Hook)

# 工具已执行，文件已写入
FILE_PATH="$1"

# 检查代码质量
if ! eslint "$FILE_PATH"; then
    echo "❌ 代码质量不通过！"
    echo "请修复 ESLint 错误"
    echo ""
    echo "建议运行: git restore $FILE_PATH"

    # 但无法强制撤销！AI 可以忽略
    exit 2  # ← 这个 exit 只是警告，不能阻止
fi
```

**问题**: AI 可以选择忽略这个警告，继续下一步。

### PostToolUse 的实际用途

| 用途 | 示例 |
|------|------|
| 日志记录 | 记录所有文件修改到日志 |
| 通知 | 发送通知到 Slack/Notion |
| 统计 | 统计代码行数变化 |
| 提示 | 提示 AI 注意某些问题 |

**不适合**: 强制质检、阻止错误操作

---

## 核心问题：Step 7 质检无法强制

### 当前情况

```
Step 7: 质检
    ├─ AI 运行: npm run qa
    ├─ 结果: 9 个测试失败 ❌
    ├─ AI 判断: "这是已有问题，不是我引入的"
    ├─ AI 决定: 跳过修复，继续下一步
    └─ Hook: 无法阻止 ❌
```

### 为什么无法强制？

1. **npm run qa 是 Bash 命令** - 不是唯一路径
2. **AI 可以不运行** - 只是流程建议
3. **AI 可以忽略结果** - 自我判断

### 可能的解决方案

#### 方案 1: 在 PreToolUse:Write 中检查质检状态

```bash
# hooks/branch-protect.sh (修改)

# 在允许写代码前，检查质检状态
if [[ -f "$PROJECT_ROOT/.quality-gate-passed" ]]; then
    # 质检已通过，允许写代码
    exit 0
else
    echo "❌ 质检未通过"
    echo "请先运行: npm run qa"
    echo "所有测试通过后，会生成 .quality-gate-passed 文件"
    exit 2
fi
```

**问题**:
- AI 可以自己创建 `.quality-gate-passed` 文件
- 增加工作流复杂度
- 每次写代码都要先质检

#### 方案 2: 接受现实，依赖 CI

```
Step 7: 质检 (AI 自觉) - 0% 强制
    ↓
Step 8: PR Gate (Hook) - 60% 强制
    ├─ 检查产物存在
    └─ 运行 npm run qa (会失败)
    ↓
Step 9: CI (GitHub) - 100% 强制
    ├─ 强制运行所有测试
    └─ 失败则无法合并
    ↓
Step 10: A+ (GitHub) - 100% 强制
    └─ CI 绿才能合并
```

**优点**:
- 现实可行
- 最终防线可靠
- 不影响开发体验

**缺点**:
- AI 可能创建失败的 PR
- 浪费 CI 配额

#### 方案 3: PostToolUse 提示 + AI 自律

```bash
# hooks/post-code-check.sh (PostToolUse Hook)

# 文件已写入，运行质检
npm run qa

if [ $? -ne 0 ]; then
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "  ⚠️  质检失败！"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "根据 /dev 工作流，你应该："
    echo "1. 修复失败的测试"
    echo "2. 重新运行 npm run qa"
    echo "3. 确保全部通过后再继续"
    echo ""
    echo "如果这是已有问题，请先修复再提交你的代码"
    exit 2
fi
```

**问题**: AI 可以忽略这个提示

---

## 真实的防护地图

```
┌─────────────────────────────────────────────────────────────┐
│  本地阶段 (Local)                                            │
├─────────────────────────────────────────────────────────────┤
│  Step 1-6: 写代码                  ✅ 100% (PreToolUse)     │
│  Step 7: 质检                      ❌ 0% (AI 自觉)          │
│  Step 8: PR 创建                   ⚠️ 60% (多路径)          │
└─────────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  服务器阶段 (GitHub)                                         │
├─────────────────────────────────────────────────────────────┤
│  Step 9: CI                        ✅ 100% (服务器端)       │
│  Step 10: 人工审核                 ✅ 100% (A+)             │
│  Step 11: 合并                     ✅ 100% (A+)             │
└─────────────────────────────────────────────────────────────┘
```

### 关键洞察

| 阶段 | 防护能力 | 原因 |
|------|---------|------|
| **写代码阶段** | ✅ 100% | PreToolUse + 唯一路径 |
| **质检阶段** | ❌ 0% | AI 自觉 + 多路径 |
| **CI/合并阶段** | ✅ 100% | 服务器端 + 无法绕过 |

---

## 最终建议

### 现实可行的方案

```
1. PreToolUse (写代码): 100% 强制 ✅
   └─ 防止在错误分支写代码
   └─ 防止没有 PRD/DoD 写代码

2. 质检阶段: 0% 强制 ❌
   └─ 依赖 AI 自觉
   └─ 提示但不强制

3. PR Gate: 60% 强制 ⚠️
   └─ 拦截明显的 PR 创建
   └─ 运行质检检查（但可能已经绕过）

4. CI: 100% 强制 ✅
   └─ 真正的质检门控
   └─ 无法绕过

5. A+: 100% 强制 ✅
   └─ 人工审核
   └─ 最后防线
```

### 核心原则

**唯一路径的用 PreToolUse，多路径的用 CI + A+**

- ✅ 写代码权限 → PreToolUse 100%
- ❌ 质检执行 → CI 100%
- ❌ PR 创建 → CI + A+ 100%
- ✅ 最终合并 → A+ 100%

---

## 风险接受声明（基于官方文档）

### PostToolUse 无法撤销

**官方确认**: PostToolUse 运行在工具执行**之后**，无法阻止或撤销操作。

```
PreToolUse (工具执行前):
    exit 2 → 阻止工具执行 ✅

PostToolUse (工具执行后):
    exit 2 → 只是警告，无法撤销 ❌
    工具已执行，文件已修改 ❌
```

### 已知风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| AI 跳过本地质检 | 中 | 低 | CI 会拦截（100%）|
| AI 创建失败的 PR | 中 | 低 | 浪费 CI 配额，但不影响代码质量 |
| AI 用其他语言绕过 pr-gate | 低 | 低 | CI 会拦截（100%）|
| AI 不写测试 | 中 | 低 | CI 测试覆盖率检查（100%）|

### 为什么风险可接受？

**最终防线永远有效**:

```
即使 AI:
├─ 跳过本地质检
├─ 绕过 pr-gate Hook
├─ 不写测试
└─ 创建了 PR

也会被拦住:
├─ CI 测试失败 → 无法合并
├─ CI 构建失败 → 无法合并
├─ 没有人工审核 → 无法合并
└─ A+ 保护 → 100% 有效
```

**所以风险可控！**

### Hook 定位

**Hook = 门卫，不是监工**

```
门卫职责（100% 有效）:
✅ 检查入场券（分支、PRD、DoD）
✅ 拦截明显违规（gh pr create）
✅ 快速失败（减少 CI 浪费）

监工职责（0% 有效，由 CI 承担）:
❌ 监督工作质量（代码质量）
❌ 检查产出物（测试覆盖率）
❌ 强制执行流程（质检）

→ 监工职责 100% 由 CI + A+ 承担
```

### 最终结论

**接受方案 2（分层防护）**:

1. **Hook (60%)**: 快速失败，拦截明显错误
2. **CI (100%)**: 真正的质检门控
3. **A+ (100%)**: 人工审核，最后防线

**不需要做的**:
- ❌ 不添加 PostToolUse Hook（无法强制）
- ❌ 不添加质检门控文件（可被伪造）
- ❌ 不追求 Hook 100% 拦截（承认多路径）

**详细方案**: 参见 `docs/HOOK-ENFORCEMENT-STRATEGY.md`

---

*生成时间: 2026-01-24*
*更新时间: 2026-01-24 (添加官方文档验证 + 风险声明)*
