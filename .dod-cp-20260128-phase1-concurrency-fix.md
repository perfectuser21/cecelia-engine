---
id: dod-phase1-concurrency-fix
version: 1.0.0
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.0: 初始版本
---

# DoD: Phase 1 并发安全修复

QA: docs/QA-DECISION.md

## 验收清单

### T-001: track.sh 原子写入
- [ ] save_run_id 函数使用 mktemp + mv 模式
- [ ] 错误时清理临时文件
- [ ] 测试: 并发调用不会损坏文件

### T-002: 状态文件分支隔离
- [ ] TRACK_FILE 包含分支名 (.cecelia-run-id-${BRANCH})
- [ ] get_run_id 向后兼容旧格式
- [ ] clear_run_id 清理正确的文件

### T-003: cecelia-api 命令修复
- [ ] 移除不存在的 update-task 调用
- [ ] 使用 update-run 替代，确保 PR URL 正确传递

### T-004: pr-gate-v2.sh trap 覆盖修复
- [ ] 使用 TEMP_FILES 数组管理临时文件
- [ ] 单一 cleanup_temp 函数处理所有清理
- [ ] 移除多个 trap 语句

### T-005: quality-gate 文件分支隔离
- [ ] 质检文件改为 .quality-gate-passed-${BRANCH}
- [ ] pr-gate-v2.sh 读取时使用正确的文件名
- [ ] cleanup.sh 同步更新清理逻辑

## 测试要求

- [ ] npm test 通过
- [ ] Shell 脚本语法检查通过
- [ ] 手动验证: 在两个分支同时运行不会冲突
