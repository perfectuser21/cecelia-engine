---
id: prd-test-cleanup
version: 1.0.0
created: 2026-01-30
updated: 2026-01-30
changelog:
  - 1.0.0: 初始版本
---

# PRD: 测试清理和 CI 漏洞修复（第二批）

## 背景

深度审查发现测试套件和 CI 配置存在问题：
1. 22 个测试被 skip，特别是 detect-priority 优先级检测功能
2. known-failures 文件缺失时整个白名单校验被跳过

## 问题清单

### P1-1: 22 个被 skip 的测试

**位置**: `tests/hooks/detect-priority.test.ts`（17 个）、`tests/hooks/metrics.test.ts`（3 个）、`tests/hooks/pr-gate-phase1.test.ts`（3 个）

**问题**:
- detect-priority.test.ts 中 PR_TITLE 检测功能被删除
- 但测试代码仍存在，只是被 skip
- 优先级检测是安全相关功能，不应无测试覆盖

**修复方案**:
- 分析 detect-priority.cjs 当前实现
- 删除已移除功能的测试代码
- 或重新实现优先级检测并启用测试

### P1-2: known-failures 文件缺失漏洞

**位置**: `.github/workflows/ci.yml` L149

**问题**:
```bash
if [ -f ".quality-evidence.json" ] && [ -f "ci/known-failures.json" ]; then
  # 校验逻辑
else
  # 直接失败，但实际上整个校验被跳过
fi
```

如果任一文件不存在，整个白名单校验被跳过。
攻击者可以删除 ci/known-failures.json 来绕过校验。

**修复方案**:
- 确保 ci/known-failures.json 始终存在
- 如果文件缺失，应该硬失败而非跳过校验

## 验收标准

- [ ] 清理或修复 skip 的测试
- [ ] known-failures.json 缺失时 CI 硬失败
- [ ] 测试通过数量增加或保持不变
- [ ] CI 测试通过

## 影响范围

- `tests/hooks/detect-priority.test.ts`
- `tests/hooks/metrics.test.ts`
- `tests/hooks/pr-gate-phase1.test.ts`
- `.github/workflows/ci.yml`
- `scripts/devgate/detect-priority.cjs`

## 风险评估

**中风险**：修改测试代码可能影响 CI 通过率。
需要仔细分析每个 skip 的原因再决定修复方案。
