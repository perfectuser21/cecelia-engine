# PRD - 修复 pending 阶段行为

## 背景

当前 pending 阶段行为错误：

**问题**：
- detect-phase.sh 输出：`pending: CI 运行中 → 直接退出（稍后再查）`
- 这导致用户说"继续"时，系统检测到 pending 就退出
- **但实际应该**：pending 阶段应该挂着等 CI 结果

**正确的两阶段分离含义**：
- p0 阶段：创建 PR → **退出会话**（不等 CI）✅
- **新会话**：用户说"继续" → 检测阶段 → pending → **挂着等 CI 出结果** ✅
- p1 阶段：CI fail → 修复 → push → **退出会话** ✅

## 核心问题

**误解了"两阶段分离"**：
- ❌ 错误理解：pending 是"中间态"，应该退出
- ✅ 正确理解：pending 应该进入等待循环，直到 CI 有结果（fail/pass）

## 功能描述

### 1. 修复 detect-phase.sh

将 pending 描述改为"等待 CI 结果"：

```bash
# 当前（错误）
pending: CI 运行中 → 直接退出（稍后再查）

# 应该改为
pending: CI 运行中 → 等待循环（挂着等结果）
```

### 2. 修复 SKILL.md

pending 阶段应该有明确的等待行为：

```
┌─────────────────────────────────────────────────────────┐
│              pending: 等待 CI 结果                       │
├─────────────────────────────────────────────────────────┤
│  阶段检测 → PHASE: pending                              │
│      ↓                                                  │
│  等待循环（挂着等）                                      │
│      │   while true; do                                 │
│      │     检查 CI 状态                                 │
│      │     case:                                        │
│      │       pending → sleep 30, continue               │
│      │       failure → 进入 p1 修复流程                 │
│      │       success → 进入 p2 结束流程                 │
│      │   done                                           │
│      ↓                                                  │
│  转入 p1 或 p2 阶段                                      │
└─────────────────────────────────────────────────────────┘
```

### 3. 创建新步骤文档

新建 `skills/dev/steps/09.5-pending-wait.md`：
- pending 阶段的等待循环逻辑
- 超时保护（1小时）
- CI 状态检测
- 自动转入 p1/p2

## 成功标准

1. detect-phase.sh 正确描述 pending 行为
2. SKILL.md 包含 pending 等待流程图
3. 创建 09.5-pending-wait.md
4. 用户说"继续"时，pending 阶段会挂着等 CI
5. CI 有结果后自动转入 p1/p2

## 非功能需求

- 保持两阶段分离的核心理念（阶段之间退出会话）
- pending 等待有超时保护
- 清晰的进度提示

## 范围

修改文档和阶段描述，明确 pending 应该等待而不是退出。
