---
id: prd-phase2-snapshot
version: 1.0.0
created: 2026-01-22
updated: 2026-01-22
changelog:
  - 1.0.0: 初始版本
---

# PRD: Phase 2 - PRD/DoD 历史版本化（快照）

## 背景

当前 PRD/DoD 文件在每次任务时被覆盖，导致：
1. **无法追溯历史决策** - 之前为什么这样设计？
2. **审计困难** - PR 合并后 PRD/DoD 内容丢失
3. **无法复盘** - 某个功能的原始需求是什么？

## 功能描述

实现 PRD/DoD 快照机制：**PR 创建时自动归档 → 按 PR 号存储 → 支持查看历史**

### 核心规则

1. **PR 创建时自动快照**
   - Hook 拦截 `gh pr create`
   - 复制 `.prd.md` 和 `.dod.md` 到 `.history/` 目录
   - 文件名格式：`PR-{number}-{timestamp}.prd.md`

2. **存储结构**
   ```
   .history/
   ├── PR-204-20260122-1048.prd.md
   ├── PR-204-20260122-1048.dod.md
   ├── PR-205-20260122-1130.prd.md
   └── PR-205-20260122-1130.dod.md
   ```

3. **查看命令**
   - `bash scripts/devgate/list-snapshots.sh` - 列出所有快照
   - `bash scripts/devgate/view-snapshot.sh PR-204` - 查看指定 PR 的 PRD/DoD

## 成功标准

1. PR 创建时自动保存 PRD/DoD 快照
2. 快照存储在 `.history/` 目录
3. 可以列出和查看历史快照
4. 测试覆盖核心功能

## 交付物

### 新增文件
- `scripts/devgate/snapshot-prd-dod.sh` - 快照脚本
- `scripts/devgate/list-snapshots.sh` - 列出快照
- `scripts/devgate/view-snapshot.sh` - 查看快照
- `tests/hooks/pr-gate-phase2.test.ts` - Phase 2 测试
- `.history/.gitkeep` - 历史目录

### 修改文件
- `hooks/pr-gate-v2.sh` - 接入快照功能
- `regression-contract.yaml` - 新增 H2-009

## 技术要点

- 快照在 PR 创建成功后执行（Hook exit 0 之前）
- PR 号从 `gh pr create` 输出中提取
- 时间戳格式：YYYYMMDD-HHMM

## 不做

- 自动恢复快照（手动复制即可）
- 快照压缩/打包
- 远程存储（本地 git 足够）

## 风险

- `.history/` 可能增长较快，但 markdown 文件很小
