---
id: prd-h7-concurrency-safety
version: 1.0.0
created: 2026-01-31
updated: 2026-01-31
changelog:
  - 1.0.0: 初始版本
---

# PRD: 并发安全修复 (H7)

## 功能描述

修复 ZenithJoy Engine 中 P0 级并发安全问题，防止多会话串线。

### 问题

1. 同分支多会话无隔离 - 只检查 branch，无 session_id
2. .dev-mode TOCTOU 竞态 - stop.sh 删除 vs cleanup.sh 追加无锁
3. CI 状态检查不一致 - 多处使用不同 gh 命令
4. API 轮询无重试 - 网络问题时误判

### 解决方案

1. 创建共享锁工具库 lib/lock-utils.sh
2. 创建统一 CI 状态查询库 lib/ci-status.sh
3. 为 .dev-mode 添加 session_id 机制
4. 修复 stop.sh 和 cleanup.sh 的并发竞态

## 成功标准

- session_id 写入 .dev-mode，stop.sh 验证匹配
- .dev-mode 操作使用 flock 锁保护
- CI 状态查询带重试，网络故障时不误判
- 现有测试全部通过，新增并发测试通过
