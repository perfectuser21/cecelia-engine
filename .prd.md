# PRD: 修复 Skill 调用返回后的行为矛盾

## 问题描述

当前 `/dev` 工作流中，文档对"Skill 调用返回后 AI 应该做什么"有**两种矛盾的描述**：

### 矛盾点 1：SKILL.md vs Step 文件

**skills/dev/SKILL.md** 说：
```
问题：
  /qa 和 /audit 按规范不输出总结就返回
  AI 自然停下来，需要外层循环驱动继续
```

**skills/dev/steps/04-dod.md** 和 **07-quality.md** 说：
```
**不要**停顿或等待确认
**立即**继续下一步
```

### 矛盾点 2：实际行为 vs 用户期望

**实际行为**：
- /qa Skill 返回 → AI 停下来 → Ralph Loop 检测无 promise → 重新注入 prompt → AI 继续
- 有**可见的停顿**（用户看到 "Cooked for 1m 16s"）

**用户期望**：
- /qa Skill 返回 → AI 立即继续下一步
- **无停顿**，流畅执行

### 用户反馈

- "这里为啥又停了？"（在 /qa 返回后）
- "为啥又停了一次"（再次发生）

说明停顿是**不期望的行为**。

---

## 根本原因

1. **Commit 34e95aa** (2026-01-26)：添加"不要停顿，立即继续"指令（把停顿当 bug 修）
2. **Commit 032c088** (2026-01-27)：添加"AI 自然停下来"说明（把停顿当设计）

两次修复的理解冲突，导致文档矛盾。

---

## 目标

**统一行为定义**：Skill 调用返回后，AI 应该**立即继续执行下一步**，无可见停顿。

**Ralph Loop 的正确作用**：
- 不是驱动每个步骤之间的继续
- 而是处理 CI 失败后的自动重试
- 和检测 `<promise>DONE</promise>` 来结束循环

---

## 修复方案

### 1. 修改 skills/dev/SKILL.md

**删除或修改"为什么需要循环？"章节**：

当前（错误）：
```markdown
问题：
  /qa 和 /audit 按规范不输出总结就返回
  AI 自然停下来，需要外层循环驱动继续

解决：
  - 有头：/ralph-loop plugin 检测无 <promise> → 自动继续
  - 无头：cecelia-run while 循环检测无 DONE → 再次调用 claude
```

修改为（正确）：
```markdown
### 为什么需要循环？

循环机制的作用：
1. **CI 失败自动重试**：CI 失败 → 修复代码 → push → 等 CI → 重复直到成功
2. **完成检测**：检测 `<promise>DONE</promise>` 来判断整个流程结束

**Skill 调用的处理**：
- /qa 和 /audit 调用返回后，AI 立即继续执行下一步
- 不会有停顿，不依赖循环机制驱动
- 循环机制只在 CI 失败重试和完成检测时发挥作用

实现方式：
- 有头：dev-with-loop（使用 /ralph-loop plugin）
- 无头：cecelia-run（使用 while 循环）
```

### 2. 保持 Step 文件的"立即继续"指令

**skills/dev/steps/04-dod.md** 和 **07-quality.md** 的指令是正确的，保持不变：

```markdown
### ⚡ QA Node 完成后的强制指令

**生成 QA-DECISION.md 后，立即进入 Step 4.3 (DoD 定稿)**：

1. **不要**输出"QA 决策已生成！"
2. **不要**停顿或等待确认
3. **立即**继续下一步：补全 DoD 的 Test 字段
```

### 3. 澄清 Skills 的"立即返回"含义

**skills/qa/SKILL.md** 和 **skills/audit/SKILL.md** 的"完成后行为"章节需要澄清：

当前（容易误解）：
```markdown
## ⚡ 完成后行为（CRITICAL）

**生成 QA-DECISION.md 后，立即返回调用方**：

1. **不要**输出"QA 决策已生成！现在返回 /dev 流程..."
2. **不要**停顿或输出总结
3. **立即**返回，让调用方（/dev）继续执行下一步
4. **绝对不要**等待用户确认

这个 Skill 的职责是"生成决策文件"，不是"等待确认"。
```

修改为（更清晰）：
```markdown
## ⚡ 完成后行为（CRITICAL）

**生成 QA-DECISION.md 后的行为**：

1. **不要**输出额外总结（如"QA 决策已生成！现在返回..."）
2. **直接输出结果**（Decision + Reason + Next Actions）
3. **调用方（/dev）会立即继续**执行下一步

**关键点**：
- Skill 的职责是"生成决策文件 + 简洁输出"
- 不要输出多余的总结或确认信息
- /dev 流程会在收到结果后自动继续，无需 Skill 做任何"返回"动作
```

---

## 验收标准

### 功能验收

- [ ] 执行 `dev-with-loop .prd.md` 时，/qa 和 /audit 调用返回后**无可见停顿**
- [ ] AI 在 Skill 返回后立即继续执行下一步（无需 Ralph Loop 驱动）
- [ ] Ralph Loop 只在 CI 失败重试和检测 DONE 时起作用

### 文档验收

- [ ] `skills/dev/SKILL.md` 的"为什么需要循环？"章节描述正确
- [ ] `skills/dev/steps/04-dod.md` 的"QA Node 完成后"指令保持不变
- [ ] `skills/dev/steps/07-quality.md` 的"Audit Node 完成后"指令保持不变
- [ ] `skills/qa/SKILL.md` 的"完成后行为"章节澄清含义
- [ ] `skills/audit/SKILL.md` 的"完成后行为"章节澄清含义

### 测试验收

- [ ] 手动测试：运行 `dev-with-loop .prd-test.md`，观察 /qa 和 /audit 返回后是否有停顿
- [ ] 检查 transcript：确认 Skill 返回后立即有下一步的输出
- [ ] CI 测试通过

---

## 影响范围

### 修改的文件

1. `skills/dev/SKILL.md` - 修改"为什么需要循环？"章节
2. `skills/qa/SKILL.md` - 澄清"完成后行为"章节
3. `skills/audit/SKILL.md` - 澄清"完成后行为"章节

### 不修改的文件

- `skills/dev/steps/04-dod.md` - 指令正确，保持不变
- `skills/dev/steps/07-quality.md` - 指令正确，保持不变
- Ralph Loop plugin 代码 - 无需修改
- dev-with-loop 脚本 - 无需修改

---

## 优先级

**P1 - 重要**

原因：
- 影响用户体验（可见的停顿让用户困惑）
- 文档矛盾会误导未来的开发
- 但不影响功能（目前 Ralph Loop 能绕过停顿问题）

---

## 备注

### 历史变更回顾

1. **34e95aa** (2026-01-26)：添加"不要停顿"指令 → 把停顿当 bug
2. **9f6cd55** (2026-01-26)：修复"post-PR 停顿" → 说停顿是预期行为
3. **032c088** (2026-01-27)：文档说明"AI 自然停下来" → 把停顿当设计
4. **本次修复**：统一为"不应该停顿" → 澄清矛盾

### 理解误区

之前的误解：以为 Skill "返回"就会导致 AI 停下来，需要 Ralph Loop 驱动。

正确理解：Skill 调用只是一个工具调用，返回结果后 AI 应该继续生成输出，自然进入下一步。Ralph Loop 不是用来驱动步骤继续的。
