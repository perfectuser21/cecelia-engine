# PRD - ä¿®å¤ p1 é˜¶æ®µ AI åœé¡¿é—®é¢˜ï¼ˆæŒç»­å¾ªç¯åˆ°åˆå¹¶ï¼‰

## é—®é¢˜æè¿°

å½“å‰ p1 é˜¶æ®µï¼ˆCI å¤±è´¥åçš„ä¿®å¤ï¼‰å­˜åœ¨ä¸¥é‡é—®é¢˜ï¼šAI å®¹æ˜“åœ¨å¤„ç† CI æ—¶åœé¡¿ï¼Œæ²¡æœ‰æŒç»­è¿è¡Œç›´åˆ° PR åˆå¹¶ã€‚

### æ ¹æœ¬åŸå› 

1. **09.5-pending-wait.md é€»è¾‘é”™è¯¯**ï¼šPR #290 ç§»é™¤äº† while å¾ªç¯ï¼Œæ”¹ä¸º"ç«‹å³é€€å‡º"ï¼Œè¿™æ˜¯**é”™è¯¯çš„ç†è§£**
2. **Stop hook ç¼ºå°‘ p1/pending æ£€æŸ¥**ï¼šæ²¡æœ‰é˜»æ­¢ p1/pending é˜¶æ®µçš„ä¼šè¯ç»“æŸ
3. **ç¼ºå°‘ pre-session hook**ï¼šæ–°ä¼šè¯å¼€å§‹æ—¶æ²¡æœ‰è¯†åˆ«é˜¶æ®µå¹¶æç¤ºè°ƒç”¨ /dev

### æ­£ç¡®è®¤çŸ¥

**p0 å’Œ p1+ æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„é˜¶æ®µ**ï¼š

- **p0 é˜¶æ®µ**ï¼šç‹¬ç«‹çš„ï¼Œåˆ›å»º PR å‰çš„å·¥ä½œ
  ```
  PRD â†’ DoD â†’ Code â†’ Quality â†’ PR â†’ ç»“æŸ
  ```

- **p1/pending/p2 é˜¶æ®µ**ï¼šæ˜¯**åŒä¸€ä¸ªæŒç»­å¾ªç¯**çš„ä¸åŒçŠ¶æ€
  ```
  è¿›å…¥ CI å¤„ç†å¾ªç¯
    while true:
      æ£€æŸ¥ CI çŠ¶æ€
      if CI fail (p1): ä¿®å¤ â†’ push â†’ continue
      elif CI pending: sleep 30s â†’ continue
      elif CI pass (p2): merge â†’ break
  ```

**ä¸åº”è¯¥é€€å‡ºã€ä¸åº”è¯¥é—®ç”¨æˆ·ã€å…¨è‡ªåŠ¨è¿è¡Œç›´åˆ°åˆå¹¶ï¼**

---

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ¢å¤ `skills/dev/steps/09.5-pending-wait.md` çš„ while å¾ªç¯

**é”™è¯¯çš„å½“å‰é€»è¾‘**ï¼ˆPR #290ï¼‰ï¼š
```
æ£€æµ‹ CI pending â†’ ç«‹å³ exit 0 é€€å‡º
```

**æ­£ç¡®é€»è¾‘**ï¼š
```
while true; do
  CI_STATUS=$(gh pr checks "$PR_NUMBER" ...)

  case "$CI_STATUS" in
    FAILURE|ERROR)
      åˆ†æå¤±è´¥ â†’ ä¿®å¤ä»£ç  â†’ push
      sleep 30  # ç­‰å¾… CI é‡æ–°è¿è¡Œ
      continue  # ç»§ç»­å¾ªç¯
      ;;

    PENDING|QUEUED|IN_PROGRESS)
      echo "CI è¿è¡Œä¸­ï¼Œç­‰å¾… 30 ç§’..."
      sleep 30
      continue  # ç»§ç»­å¾ªç¯
      ;;

    SUCCESS|PASS)
      echo "CI é€šè¿‡ï¼Œåˆå¹¶ PR..."
      gh pr merge --squash --delete-branch
      break  # å®Œæˆï¼Œé€€å‡ºå¾ªç¯
      ;;
  esac
done
```

### 2. Stop hook å¢åŠ  p1/pending é˜¶æ®µæ£€æŸ¥

åœ¨ `hooks/stop.sh` çš„é˜¶æ®µæ£€æµ‹éƒ¨åˆ†ï¼Œå¢åŠ å¯¹ p1/pending çš„æ‹¦æˆªï¼š

```bash
PHASE=$(bash scripts/detect-phase.sh | grep "^PHASE:" | cut -d: -f2 | xargs)

if [[ "$PHASE" == "p1" ]] || [[ "$PHASE" == "pending" ]]; then
  echo "âŒ ä¼šè¯ä¸èƒ½ç»“æŸï¼šæœ‰ PR å¾…å¤„ç†"
  echo ""
  echo "âš¡ Ralph Loop è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼š"
  echo "  1. Hook è¿”å› exit 2 = é˜»æ­¢ä¼šè¯ç»“æŸ"
  echo "  2. ä½ åº”è¯¥ç«‹å³è°ƒç”¨ /dev å¤„ç† CI"
  echo "  3. /dev å°†æŒç»­è¿è¡Œç›´åˆ° PR åˆå¹¶"
  echo ""
  echo "[SKILL_REQUIRED: dev]"
  exit 2  # é˜»æ­¢ä¼šè¯ç»“æŸ
fi
```

### 3. æ·»åŠ  session-start hook

åˆ›å»º `hooks/session-start.sh`ï¼Œåœ¨ä¼šè¯å¼€å§‹æ—¶è¯†åˆ«é˜¶æ®µå¹¶æç¤ºï¼š

```bash
#!/usr/bin/env bash
# Session-start Hook - è¯†åˆ«é˜¶æ®µå¹¶æç¤ºèµ° /dev

# åªåœ¨ zenithjoy-engine é¡¹ç›®æ£€æµ‹
if [[ ! -f "scripts/detect-phase.sh" ]]; then
  exit 0
fi

PHASE=$(bash scripts/detect-phase.sh 2>/dev/null | grep "^PHASE:" | cut -d: -f2 | xargs)
PR_NUMBER=$(gh pr list --head "$(git branch --show-current)" --state open --json number -q '.[0].number' 2>/dev/null)

if [[ "$PHASE" == "p1" ]] || [[ "$PHASE" == "pending" ]]; then
  echo "" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "  ğŸ“ å½“å‰æœ‰ PR å¾…å¤„ç†" >&2
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
  echo "" >&2
  echo "  PR: #${PR_NUMBER}" >&2
  echo "  é˜¶æ®µ: ${PHASE}" >&2
  echo "" >&2
  echo "  ğŸ’¡ å»ºè®®è°ƒç”¨ /dev å¤„ç† CI" >&2
  echo "     /dev å°†æŒç»­è¿è¡Œç›´åˆ° PR åˆå¹¶" >&2
  echo "" >&2
elif [[ "$PHASE" == "p2" ]]; then
  echo "" >&2
  echo "  âœ… PR #${PR_NUMBER} CI å·²é€šè¿‡" >&2
  echo "     GitHub å°†è‡ªåŠ¨åˆå¹¶" >&2
  echo "" >&2
fi

exit 0  # ä¸å¼ºåˆ¶ï¼Œåªæ˜¯æç¤º
```

---

## é¢„æœŸæ•ˆæœ

### p0 â†’ p1 å®Œæ•´æµç¨‹

```
[p0 é˜¶æ®µ]
ç”¨æˆ·: "ä¿®å¤ XXX"
/dev â†’ åˆ›å»º PR â†’ ç»“æŸ

[CI è¿è¡Œå¹¶å¤±è´¥]

[p1 é˜¶æ®µ - æ–°ä¼šè¯]
ç”¨æˆ·: "æŒç»­æŸ¥ CI"
Session-start hook: æç¤º"PR #100, é˜¶æ®µ p1, å»ºè®® /dev"
AI: è°ƒç”¨ /dev
/dev: æ£€æµ‹ p1 â†’ è¿›å…¥ while å¾ªç¯
  â†’ æ£€æŸ¥ CI â†’ å¤±è´¥ â†’ ä¿®å¤ â†’ push â†’ sleep 30
  â†’ æ£€æŸ¥ CI â†’ pending â†’ sleep 30
  â†’ æ£€æŸ¥ CI â†’ å¤±è´¥ â†’ ä¿®å¤ â†’ push â†’ sleep 30
  â†’ æ£€æŸ¥ CI â†’ success â†’ merge
  â†’ breakï¼ˆé€€å‡ºå¾ªç¯ï¼‰
âœ… PR å·²åˆå¹¶ï¼Œä»»åŠ¡å®Œæˆ
```

### Stop hook å…œåº•

å¦‚æœ AI å¿½ç•¥ session-start æç¤ºï¼š
```
AI: æŸ¥çœ‹ CI â†’ è¯´"å¤±è´¥äº†" â†’ æƒ³ç»“æŸä¼šè¯
Stop hook: æ£€æµ‹ p1 â†’ exit 2 é˜»æ­¢
è¾“å‡º: "ä¼šè¯ä¸èƒ½ç»“æŸï¼Œ[SKILL_REQUIRED: dev]"
AI: è¢« Ralph Loop æ‹¦ä½ â†’ è°ƒç”¨ /dev
/dev: è¿›å…¥ while å¾ªç¯ â†’ å¤„ç†åˆ°åˆå¹¶
```

---

## æˆåŠŸæ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [ ] 09.5-pending-wait.md æ¢å¤ while å¾ªç¯ï¼ˆæŒç»­è¿è¡Œåˆ°åˆå¹¶ï¼‰
      Test: manual:pending-loop-restored
- [ ] Stop hook é˜»æ­¢ p1/pending é˜¶æ®µç»“æŸ
      Test: manual:stop-hook-p1-block
- [ ] Session-start hook è¯†åˆ«å¹¶æç¤ºé˜¶æ®µ
      Test: manual:session-start-prompt
- [ ] æ–‡æ¡£æ›´æ–°ï¼šfeature-registry.yml ç‰ˆæœ¬å·
      Test: manual:registry-update

### æµ‹è¯•éªŒæ”¶

- [ ] npm run qa é€šè¿‡
      Test: contract:C2-001

---

## ä¼˜å…ˆçº§

**P0** - é˜»å¡æ— å¤´æ¨¡å¼ï¼ˆCeceliaï¼‰çš„ p1 é˜¶æ®µæ‰§è¡Œ

## å½±å“èŒƒå›´

- **æ ¸å¿ƒæµç¨‹**: W1 (Two-Phase Dev Workflow)
- **ç›¸å…³ Feature**: H7 (Stop Hook), N1 (Cecelia Headless)
- **å½±å“æ–‡ä»¶**:
  - `skills/dev/steps/09.5-pending-wait.md` (å®Œå…¨é‡å†™)
  - `hooks/stop.sh` (å¢å¼º p1/pending æ£€æŸ¥)
  - `hooks/session-start.sh` (æ–°å¢)
