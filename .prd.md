# PRD: Ralph Loop è¿­ä»£è¿½è¸ªæœºåˆ¶

## èƒŒæ™¯

å½“å‰é—®é¢˜ï¼š
- ä½¿ç”¨ `/ralph-loop` æ—¶ï¼Œæ— æ³•çŸ¥é“æ€»å…±è¿­ä»£äº†å¤šå°‘æ¬¡
- ä¸çŸ¥é“æ¯æ¬¡è¿­ä»£ä¸ºä»€ä¹ˆå¤±è´¥ï¼ˆStop Hook é˜»æ­¢çš„å…·ä½“åŸå› ï¼‰
- Stop Hook å’Œ CI ä¸­æ²¡æœ‰æ˜¾ç¤ºè¿­ä»£ç»Ÿè®¡
- ç¼ºå°‘æ•´ä½“æŠ¥å‘Šå±•ç¤ºå®Œæ•´çš„è¿­ä»£è¿‡ç¨‹

## ç›®æ ‡

åœ¨ Stop Hook å’Œ CI ä¸­æ·»åŠ  ralph-loop è¿­ä»£è¿½è¸ªï¼š

1. **è‡ªåŠ¨è®°å½•æ¯æ¬¡è¿­ä»£**ï¼šStop Hook è¢«è§¦å‘æ—¶è‡ªåŠ¨è®°å½•
2. **è¿½è¸ªå¤±è´¥åŸå› **ï¼šè®°å½•æ¯æ¬¡ exit 2 çš„å…·ä½“åŸå› ï¼ˆStep 7.1/7.2/7.3/8/9 å“ªä¸€æ­¥å¤±è´¥ï¼‰
3. **å®æ—¶æ˜¾ç¤º**ï¼šStop Hook è¾“å‡ºæ—¶æ˜¾ç¤º"è¿™æ˜¯ç¬¬ N æ¬¡è¿­ä»£"
4. **CI é›†æˆ**ï¼šåœ¨ GitHub Actions ä¸­æ˜¾ç¤ºè¿­ä»£ç»Ÿè®¡
5. **æœ€ç»ˆæŠ¥å‘Š**ï¼šä¼šè¯ç»“æŸæ—¶ç”Ÿæˆå®Œæ•´çš„è¿­ä»£æŠ¥å‘Š

## æ ¸å¿ƒè®¾è®¡

### è¿½è¸ªæ–‡ä»¶ï¼š`.ralph-loop-tracking.json`

```json
{
  "project": "zenithjoy-engine",
  "branch": "cp-01241234-xxx",
  "start_time": "2026-01-24T10:00:00Z",
  "iterations": [
    {
      "iteration": 1,
      "timestamp": "2026-01-24T10:05:00Z",
      "phase": "p0",
      "result": "blocked",
      "blocked_at": "Step 7.2",
      "reason": "Audit Decision: FAIL (L1/L2 issues found)"
    },
    {
      "iteration": 2,
      "timestamp": "2026-01-24T10:10:00Z",
      "phase": "p0",
      "result": "blocked",
      "blocked_at": "Step 7.3",
      "reason": "Quality gate failed (tests not passing)"
    },
    {
      "iteration": 3,
      "timestamp": "2026-01-24T10:15:00Z",
      "phase": "p0",
      "result": "blocked",
      "blocked_at": "Step 8",
      "reason": "PR not created yet"
    },
    {
      "iteration": 4,
      "timestamp": "2026-01-24T10:20:00Z",
      "phase": "p0",
      "result": "success",
      "message": "PR created (#259), p0 phase completed"
    }
  ],
  "total_iterations": 4,
  "final_status": "success"
}
```

### Stop Hook ä¿®æ”¹

åœ¨ `hooks/stop.sh` ä¸­æ·»åŠ è¿½è¸ªé€»è¾‘ï¼š

```bash
# åœ¨å¼€å¤´æ·»åŠ è¿½è¸ªåˆå§‹åŒ–
TRACKING_FILE="$PROJECT_ROOT/.ralph-loop-tracking.json"

# è¯»å–å½“å‰è¿­ä»£æ¬¡æ•°
CURRENT_ITERATION=1
if [[ -f "$TRACKING_FILE" ]]; then
    CURRENT_ITERATION=$(jq '.total_iterations + 1' "$TRACKING_FILE" 2>/dev/null || echo "1")
fi

# åœ¨æ£€æŸ¥å¤±è´¥æ—¶è®°å½•
function record_iteration() {
    local blocked_at="$1"
    local reason="$2"
    local result="${3:-blocked}"  # blocked | success

    # åˆ›å»ºæˆ–æ›´æ–°è¿½è¸ªæ–‡ä»¶
    bash "$PROJECT_ROOT/scripts/ralph-tracker.sh" record \
        --iteration "$CURRENT_ITERATION" \
        --phase "$PHASE" \
        --result "$result" \
        --blocked-at "$blocked_at" \
        --reason "$reason"
}

# åœ¨æ¯ä¸ª exit 2 å‰è°ƒç”¨
# ä¾‹å¦‚ï¼šStep 7.2 å¤±è´¥
if [[ "$AUDIT_DECISION" != "PASS" ]]; then
    record_iteration "Step 7.2" "Audit Decision: $AUDIT_DECISION"
    echo "  ğŸ“Š Ralph Loop è¿­ä»£: #$CURRENT_ITERATION (æ€»è®¡ $CURRENT_ITERATION æ¬¡)" >&2
    exit 2
fi
```

### Stop Hook è¾“å‡ºç¤ºä¾‹

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  [Stop Hook: Step 7 è´¨æ£€é—¨æ§]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  åˆ†æ”¯: cp-01241234-rci-tracker
  ğŸ“Š Ralph Loop è¿­ä»£: #2 (æ€»è®¡ 2 æ¬¡)

  âŒ Step 7.2: Audit æœªé€šè¿‡ï¼

  å½“å‰ Decision: FAIL

  ä¹‹å‰è¿­ä»£å†å²:
    Iteration 1: é˜»æ­¢åœ¨ Step 7.3 (æµ‹è¯•å¤±è´¥)
    Iteration 2: é˜»æ­¢åœ¨ Step 7.2 (Audit Decision: FAIL)  â† å½“å‰

  ä½ éœ€è¦:
    1. æŸ¥çœ‹ docs/AUDIT-REPORT.md ä¸­çš„ Findings
    2. ä¿®å¤æ‰€æœ‰ L1 å’Œ L2 é—®é¢˜
    3. é‡æ–°è¿è¡Œ /audit
```

### CI é›†æˆ

åœ¨ `.github/workflows/test.yml` ä¸­æ·»åŠ ï¼š

```yaml
- name: Display Ralph Loop Metrics
  if: always()
  run: |
    if [[ -f .ralph-loop-tracking.json ]]; then
      echo "## ğŸ“Š Ralph Loop ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "**æ€»è¿­ä»£æ¬¡æ•°**: $(jq '.total_iterations' .ralph-loop-tracking.json)" >> $GITHUB_STEP_SUMMARY
      echo "" >> $GITHUB_STEP_SUMMARY
      echo "### è¿­ä»£å†å²" >> $GITHUB_STEP_SUMMARY
      jq -r '.iterations[] | "- **Iteration \(.iteration)**: \(.result) at \(.blocked_at // "completed") - \(.reason // .message)"' .ralph-loop-tracking.json >> $GITHUB_STEP_SUMMARY
    fi
```

### æœ€ç»ˆæŠ¥å‘Š

å½“ ralph-loop å®Œæˆåï¼ˆexit 0ï¼‰ï¼Œç”ŸæˆæŠ¥å‘Šï¼š

```bash
# åœ¨ Stop Hook exit 0 ä¹‹å‰
if [[ -f "$TRACKING_FILE" ]]; then
    echo "" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "  ğŸ“Š Ralph Loop å®ŒæˆæŠ¥å‘Š" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    bash "$PROJECT_ROOT/scripts/ralph-tracker.sh" report
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
fi
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ“Š Ralph Loop å®ŒæˆæŠ¥å‘Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ä»»åŠ¡: å®ç° Ralph Loop è¿½è¸ªæœºåˆ¶
åˆ†æ”¯: cp-01241234-ralph-tracker
æ€»è¿­ä»£: 4 æ¬¡
æ€»è€—æ—¶: 15 åˆ†é’Ÿ

è¿­ä»£å†å²:
  Iteration 1 (10:05): âŒ é˜»æ­¢åœ¨ Step 7.2
    â†’ åŸå› : Audit Decision: FAIL

  Iteration 2 (10:10): âŒ é˜»æ­¢åœ¨ Step 7.3
    â†’ åŸå› : Quality gate failed

  Iteration 3 (10:15): âŒ é˜»æ­¢åœ¨ Step 8
    â†’ åŸå› : PR not created yet

  Iteration 4 (10:20): âœ… æˆåŠŸ
    â†’ PR #259 å·²åˆ›å»ºï¼Œp0 é˜¶æ®µå®Œæˆ

æˆåŠŸç‡: 1/4 (25%)
å¹³å‡è¿­ä»£æ—¶é•¿: 3.75 åˆ†é’Ÿ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## å®ç°æ–‡ä»¶

### `scripts/ralph-tracker.sh`

```bash
#!/usr/bin/env bash
# Ralph Loop è¿½è¸ªå·¥å…·

TRACKING_FILE=".ralph-loop-tracking.json"

function init() {
    # åˆå§‹åŒ–è¿½è¸ªæ–‡ä»¶
    cat > "$TRACKING_FILE" <<EOF
{
  "project": "$(basename "$(pwd)")",
  "branch": "$(git rev-parse --abbrev-ref HEAD)",
  "start_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "iterations": [],
  "total_iterations": 0
}
EOF
}

function record() {
    # è®°å½•ä¸€æ¬¡è¿­ä»£
    # å‚æ•°: --iteration N --phase p0 --result blocked --blocked-at "Step 7.2" --reason "..."

    # è§£æå‚æ•°
    local iteration phase result blocked_at reason
    while [[ $# -gt 0 ]]; do
        case $1 in
            --iteration) iteration="$2"; shift 2 ;;
            --phase) phase="$2"; shift 2 ;;
            --result) result="$2"; shift 2 ;;
            --blocked-at) blocked_at="$2"; shift 2 ;;
            --reason) reason="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆå§‹åŒ–
    [[ ! -f "$TRACKING_FILE" ]] && init

    # æ·»åŠ è¿­ä»£è®°å½•
    jq --arg iter "$iteration" \
       --arg phase "$phase" \
       --arg result "$result" \
       --arg blocked "$blocked_at" \
       --arg reason "$reason" \
       --arg ts "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
       '.iterations += [{
           iteration: ($iter | tonumber),
           timestamp: $ts,
           phase: $phase,
           result: $result,
           blocked_at: $blocked,
           reason: $reason
       }] | .total_iterations = .iterations | length' \
       "$TRACKING_FILE" > "${TRACKING_FILE}.tmp" && mv "${TRACKING_FILE}.tmp" "$TRACKING_FILE"
}

function report() {
    # ç”ŸæˆæŠ¥å‘Š
    if [[ ! -f "$TRACKING_FILE" ]]; then
        echo "æ— è¿½è¸ªæ•°æ®"
        return
    fi

    # è¯»å–æ•°æ®
    local total=$(jq '.total_iterations' "$TRACKING_FILE")
    local project=$(jq -r '.project' "$TRACKING_FILE")
    local branch=$(jq -r '.branch' "$TRACKING_FILE")

    echo ""
    echo "ä»»åŠ¡: $project"
    echo "åˆ†æ”¯: $branch"
    echo "æ€»è¿­ä»£: $total æ¬¡"
    echo ""
    echo "è¿­ä»£å†å²:"

    jq -r '.iterations[] |
        "  Iteration \(.iteration) (\(.timestamp | split("T")[1] | split(".")[0])): " +
        (if .result == "blocked" then "âŒ é˜»æ­¢åœ¨ \(.blocked_at)\n    â†’ åŸå› : \(.reason)"
         else "âœ… æˆåŠŸ\n    â†’ \(.reason // .message)" end) + "\n"' \
        "$TRACKING_FILE"
}

# ä¸»å‘½ä»¤
case "$1" in
    init) init ;;
    record) shift; record "$@" ;;
    report) report ;;
    *) echo "Usage: ralph-tracker.sh {init|record|report}"; exit 1 ;;
esac
```

## éªŒæ”¶æ ‡å‡† (DoD)

- [ ] `scripts/ralph-tracker.sh` å®ç°æ‰€æœ‰å‘½ä»¤ï¼ˆinit, record, reportï¼‰
- [ ] `.ralph-loop-tracking.json` æ ¼å¼æ­£ç¡®ï¼Œæ”¯æŒå¢é‡è¿½åŠ 
- [ ] `hooks/stop.sh` æ¯æ¬¡è¢«è§¦å‘æ—¶è‡ªåŠ¨è®°å½•è¿­ä»£
- [ ] Stop Hook è¾“å‡ºæ˜¾ç¤ºå½“å‰è¿­ä»£ç¼–å·å’Œå†å²
- [ ] `.github/workflows/test.yml` åœ¨ summary æ˜¾ç¤ºè¿­ä»£ç»Ÿè®¡
- [ ] æœ€ç»ˆæŠ¥å‘Šæ ¼å¼æ¸…æ™°ï¼ŒåŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯
- [ ] æ‰‹åŠ¨æµ‹è¯•ï¼šè§¦å‘ ralph-loop å¤šæ¬¡è¿­ä»£ï¼ŒéªŒè¯è¿½è¸ªæ­£ç¡®
- [ ] æ‰‹åŠ¨æµ‹è¯•ï¼šæ£€æŸ¥ CI summary æ˜¾ç¤ºæ­£ç¡®
- [ ] å½’æ¡£ï¼šè¿­ä»£å®Œæˆåå°†è¿½è¸ªæ–‡ä»¶å½’æ¡£åˆ° `.archive/ralph-loops/`
- [ ] æ–‡æ¡£ï¼šæ›´æ–° `docs/RALPH-LOOP-TRACKING.md` è¯´æ˜ä½¿ç”¨æ–¹å¼

## éç›®æ ‡

- âŒ ä¸è¿½è¸ªé ralph-loop çš„æ™®é€šä¼šè¯
- âŒ ä¸ä¸Šä¼ è¿½è¸ªæ•°æ®åˆ°å¤–éƒ¨æœåŠ¡
- âŒ ä¸å¹²æ‰°ç°æœ‰ Stop Hook æ£€æŸ¥é€»è¾‘
- âŒ ä¸é™åˆ¶ ralph-loop çš„è¿­ä»£æ¬¡æ•°ï¼ˆç”± --max-iterations æ§åˆ¶ï¼‰

## æŠ€æœ¯ç»†èŠ‚

- ä½¿ç”¨ Bash + jq å®ç°ï¼ˆä¿æŒå·¥å…·é“¾ä¸€è‡´ï¼‰
- è¿½è¸ªæ–‡ä»¶å­˜å‚¨åœ¨é¡¹ç›®æ ¹ç›®å½• `.ralph-loop-tracking.json`
- Stop Hook æ¯æ¬¡è§¦å‘æ—¶è°ƒç”¨ `ralph-tracker.sh record`
- Exit 0 æ—¶è°ƒç”¨ `ralph-tracker.sh report` ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
- å½’æ¡£åˆ° `.archive/ralph-loops/$(git rev-parse --abbrev-ref HEAD)-$(date +%Y%m%d-%H%M%S).json`
