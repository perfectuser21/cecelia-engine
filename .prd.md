---
id: prd-baseline-verification
version: 1.0.0
created: 2026-01-24
updated: 2026-01-24
changelog:
  - 1.0.0: 深度基线验证 PRD
---

# PRD - 深度基线验证 (Deep Baseline Verification)

Priority: P0

## 背景

**当前状态**：
- 仓库：perfectuser21/zenithjoy-engine (个人 Pro 账户)
- 保护等级：A- (95%)
- Branch Protection：已修复 (required_pull_request_reviews 配置正确)
- Trust Proof Suite：10/10 通过

**问题**：
- 2026-01-23 发生配置错误导致的 bypass 事件
- 需要深度验证当前基线是否真正可靠
- 需要确保 /dev 工作流 100% 可用
- 需要明确 A- (95%) 的实际防护能力

**目标**：通过全面测试验证当前系统的可靠性，提供清晰的证据和结论。

---

## 核心验证目标

1. **工作流完整性**：/dev 四种模式 100% 可用
2. **防护有效性**：所有已知 bypass 手段均被阻止
3. **三层防御**：Hook + GitHub + CI 三层全部激活
4. **稳定性**：并发场景、冲突场景下系统稳定

---

## Phase 1: /dev 工作流完整性验证

### 1.1 四种模式测试

| 模式 | 触发条件 | 预期行为 | 验证步骤 |
|------|---------|---------|----------|
| **new** | 在 develop/main | PRD → 分支 → DoD → 代码 → PR → CI → Merge | 完整执行一次新任务流程 |
| **continue** | 在 cp-*/feature/* + 无 PR | 继续开发/测试 | 在现有分支继续工作 |
| **fix** | 有 PR + CI 红 | 直接进入修复 | 模拟 CI 失败后修复 |
| **merge** | 有 PR + CI 绿 | Learning → Cleanup → Merge | 完成合并流程 |

### 1.2 关键节点验证

- [ ] PRD 检测（.prd.md 必须存在且有效）
- [ ] 分支命名规则（cp-MMDDHHNN-* 或 feature/*）
- [ ] DoD 生成（包含 QA 决策引用）
- [ ] 质检门控（Audit Node 必须 PASS）
- [ ] PR Gate（pr-gate-v2.sh 检查产物）
- [ ] Cleanup（分支清理，worktree 清理）

### 交付物
- `tests/workflow-integrity.test.sh` - 自动化测试脚本
- `docs/WORKFLOW-TEST-REPORT.md` - 详细测试结果

---

## Phase 2: Branch Protection 绕过测试

### 2.1 直接推送场景 (12 tests)

| # | 场景 | 命令 | 预期结果 | 证据 |
|---|------|------|----------|------|
| 1 | 直接 push main | `git checkout main && git push` | ❌ 403 拒绝 | API error log |
| 2 | 直接 push develop | `git checkout develop && git push` | ❌ 403 拒绝 | API error log |
| 3 | Force push main | `git push -f origin main` | ❌ 403 拒绝 | API error log |
| 4 | Force push develop | `git push -f origin develop` | ❌ 403 拒绝 | API error log |
| 5 | Delete branch main | `git push origin :main` | ❌ 403 拒绝 | API error log |
| 6 | Delete branch develop | `git push origin :develop` | ❌ 403 拒绝 | API error log |
| 7 | gh CLI 绕过 | `gh pr merge --admin` | ❌ 拒绝或要求 CI | API error log |
| 8 | API 绕过 (merge) | `gh api -X PUT repos/.../pulls/X/merge` | ❌ 405/422 | API response |
| 9 | API 绕过 (update ref) | `gh api -X PATCH repos/.../git/refs/heads/main` | ❌ 422 | API response |
| 10 | Git 内部绕过 | `git update-ref refs/heads/main` + push | ❌ 403 | API error log |
| 11 | 无 PR 直接 push | 修改 main 后直接 push | ❌ 403 | API error log |
| 12 | 绕过 CI 合并 | PR 存在但 CI 未跑完就合并 | ❌ 要求 CI | API response |

### 2.2 合法流程测试 (2 tests)

| # | 场景 | 预期结果 |
|---|------|----------|
| 13 | 正常 PR 流程 | ✅ CI 绿 → 可合并 |
| 14 | /dev 完整流程 | ✅ 全流程通过 |

### 交付物
- `tests/bypass-prevention.test.sh` - 自动化绕过测试
- `docs/BYPASS-TEST-REPORT.md` - 详细测试结果
- 证据截图/日志（每个测试场景）

---

## Phase 3: 三层防御验证

### 3.1 Layer 1 - Local Hook (branch-protect.sh)

**验证点**：
- [ ] 在 main/develop 执行 Write → 被阻止 + `[SKILL_REQUIRED: dev]` 提示
- [ ] 在 cp-* 无 PRD 执行 Write → 被阻止 + 提示创建 PRD
- [ ] 在 cp-* 有 PRD 执行 Write → ✅ 通过
- [ ] Hook 日志输出正确

**测试方法**：
```bash
# 1. 在 develop 尝试写代码
git checkout develop
echo "test" > test.ts
# 预期：Hook 阻止

# 2. 在 cp-* 无 PRD 尝试写代码
git checkout -b cp-test
echo "test" > test.ts
# 预期：Hook 阻止

# 3. 在 cp-* 有 PRD 写代码
echo "# PRD" > .prd.md
echo "test" > test.ts
# 预期：Hook 通过
```

### 3.2 Layer 2 - GitHub Branch Protection

**验证点**：
- [ ] `enforce_admins: true` 生效
- [ ] `required_pull_request_reviews.required_approving_review_count: 0` 生效（要求 PR）
- [ ] `required_status_checks` 生效（要求 CI）
- [ ] `allow_force_pushes: false` 生效
- [ ] `allow_deletions: false` 生效

**测试方法**：
```bash
# 查询当前配置
gh api repos/perfectuser21/zenithjoy-engine/branches/main/protection

# 尝试直接推送（应该被拒绝）
git checkout main
git commit --allow-empty -m "test"
git push origin main
# 预期：HTTP 403

# 尝试 force push（应该被拒绝）
git push -f origin main
# 预期：HTTP 403
```

### 3.3 Layer 3 - CI (GitHub Actions)

**验证点**：
- [ ] PR 创建后自动触发 CI
- [ ] CI 包含 `npm run qa` 测试
- [ ] CI 失败时无法合并
- [ ] CI 成功后允许合并

**测试方法**：
1. 创建包含错误的 PR → CI 应该失败 → 无法合并
2. 修复错误推送 → CI 应该成功 → 可以合并

### 交付物
- `tests/three-layer-defense.test.sh` - 自动化三层测试
- `docs/DEFENSE-LAYER-REPORT.md` - 每层详细验证结果

---

## Phase 4: 压力测试与边界场景

### 4.1 并发场景

- [ ] 多个 PR 同时存在（develop ← cp-1, cp-2, cp-3）
- [ ] 并发合并（快速连续合并多个 PR）
- [ ] Worktree 并发（主工作区 + 2 个 worktree 同时开发）

### 4.2 冲突场景

- [ ] Merge conflict 时的处理
- [ ] PR 过时时的处理（base 分支已更新）
- [ ] CI 失败后的修复流程

### 4.3 边界情况

- [ ] PRD 文件为空
- [ ] DoD 文件缺失关键字段
- [ ] Audit Report 结果为 FAIL
- [ ] 分支命名不符合规则

### 交付物
- `tests/stress-test.test.sh` - 压力测试脚本
- `docs/STRESS-TEST-REPORT.md` - 测试结果

---

## Phase 5: A- (95%) vs A+ (100%) 对比分析

### 5.1 A- 当前能力矩阵

| 防护项 | A- 状态 | 实际效果 | 证据 |
|--------|---------|----------|------|
| 阻止直接 push | ✅ | 403 拒绝 | API error |
| 要求 PR | ✅ | 必须创建 PR | GitHub 配置 |
| 要求 CI | ✅ | CI 必须绿 | GitHub 配置 |
| 阻止 force push | ✅ | 403 拒绝 | API error |
| 阻止分支删除 | ✅ | 403 拒绝 | API error |
| Admin 绕过 | ❌ | Owner 可点击合并按钮 | 手动测试 |

### 5.2 A+ 额外能力

| 防护项 | 需要功能 | 个人 Pro | Org Team |
|--------|---------|----------|----------|
| 限制合并执行者 | Push Restrictions | ❌ 不支持 | ✅ 支持 |
| 只允许 Bot 合并 | restrictions.apps | ❌ 不支持 | ✅ 支持 |

### 5.3 实际风险评估

**风险场景**：Owner 在 GitHub UI 点击 "Merge pull request" 按钮绕过本地流程

**当前防护**：
- ✅ CI 必须绿（无法绕过）
- ✅ PR 必须存在（无法直接 push）
- ❌ 无法阻止 Owner 点击合并按钮

**实际影响**：
- 单人开发 + 全自动化 → 风险极低（Owner 不会手动点击）
- 手动点击也需要 CI 绿 → 代码质量有保障
- 如果 Owner 恶意绕过 → A- 和 A+ 都无法防御（Owner 可以直接修改 GitHub 配置）

### 交付物
- `docs/A-MINUS-VS-A-PLUS.md` - 详细对比分析
- `docs/RISK-ASSESSMENT.md` - 实际风险评估

---

## 最终交付物总览

### 测试脚本
```
tests/
├── workflow-integrity.test.sh     # Phase 1: 工作流完整性
├── bypass-prevention.test.sh      # Phase 2: 绕过测试
├── three-layer-defense.test.sh    # Phase 3: 三层防御
├── stress-test.test.sh            # Phase 4: 压力测试
└── baseline-verification.sh       # 总控脚本（运行全部测试）
```

### 测试报告
```
docs/
├── BASELINE-VERIFICATION-REPORT.md  # 总报告
├── WORKFLOW-TEST-REPORT.md          # 工作流测试详情
├── BYPASS-TEST-REPORT.md            # 绕过测试详情
├── DEFENSE-LAYER-REPORT.md          # 三层防御详情
├── STRESS-TEST-REPORT.md            # 压力测试详情
├── A-MINUS-VS-A-PLUS.md             # 对比分析
└── RISK-ASSESSMENT.md               # 风险评估
```

### 证据文件
```
evidence/
├── bypass-tests/                  # 每个 bypass 测试的截图/日志
├── workflow-tests/                # 工作流测试证据
├── defense-layer-tests/           # 三层防御测试证据
└── api-responses/                 # API 调用响应
```

---

## 验收标准

### 必要条件（全部满足）

- [ ] **工作流完整性**：4 种模式全部测试通过
- [ ] **绕过测试**：14 个测试场景全部符合预期（12 个拒绝 + 2 个通过）
- [ ] **三层防御**：每层独立验证通过
- [ ] **压力测试**：所有边界场景处理正确
- [ ] **证据完整**：每个测试都有截图/日志/API 响应

### 成功指标

**Baseline Verification Suite**：
```bash
bash tests/baseline-verification.sh

# 预期输出：
========================================
  BASELINE VERIFICATION SUMMARY
========================================
Phase 1 - Workflow Integrity:     ✅ 4/4 modes passed
Phase 2 - Bypass Prevention:      ✅ 14/14 tests passed
Phase 3 - Three-Layer Defense:    ✅ 3/3 layers verified
Phase 4 - Stress Testing:         ✅ 8/8 scenarios passed
----------------------------------------
Total:                            ✅ 29/29 tests passed
Status:                           A- (95%) VERIFIED
Recommendation:                   CURRENT BASELINE IS SUFFICIENT
```

### 最终结论

报告必须明确回答：
1. **/dev 工作流是否 100% 可用？** → 是/否 + 证据
2. **A- (95%) 保护是否真正有效？** → 是/否 + 证据
3. **已知的 bypass 手段是否全部阻止？** → 是/否 + 列表
4. **是否需要升级到 A+ (100%)？** → 是/否 + 理由

---

## 约束条件

1. **全部自动化**：所有测试必须可重复执行
2. **证据完整**：每个断言必须有证据支撑
3. **真实环境**：在实际 GitHub 仓库测试（不用 mock）
4. **无破坏性**：测试不能影响现有代码和历史

---

## 风险与注意事项

### 测试风险
- 绕过测试可能触发 GitHub API 限流 → 添加延迟
- 并发测试可能产生冲突 → 使用隔离分支
- 压力测试可能产生大量临时数据 → 测试后清理

### 回滚方案
- 所有测试在临时分支进行
- 测试完成后立即清理
- 保留完整的测试日志

---

## 时间估算

| Phase | 预计时间 |
|-------|----------|
| Phase 1: 工作流完整性 | 30 分钟 |
| Phase 2: 绕过测试 | 45 分钟 |
| Phase 3: 三层防御 | 30 分钟 |
| Phase 4: 压力测试 | 30 分钟 |
| Phase 5: 对比分析 | 15 分钟 |
| **总计** | **~2.5 小时** |

---

## 成功标准

运行 `bash tests/baseline-verification.sh` 输出：
```
========================================
Status:     A- (95%) VERIFIED ✅
Tests:      29/29 PASSED
Confidence: 100%
Conclusion: CURRENT BASELINE IS SUFFICIENT FOR SINGLE-DEV AUTOMATED WORKFLOW
========================================
```
