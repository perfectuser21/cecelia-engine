# PRD - P0 质检强制三件套（防能力漂移、口头通过、本地绕过）

## 需求来源

用户需求：
1. 添加 Ralph Loop 使用说明到文档
2. 修复运行时文件遗留问题（.prd.md, .dod.md 等被 git 追踪）
3. 修复测试失败问题（detect-priority 测试持续失败）

## 问题

### 1. 缺少 Ralph Loop 使用文档
- skills/dev/SKILL.md 中没有 Ralph Loop 使用说明
- 用户不知道如何在 P0/P1 阶段启动 Ralph Loop
- 不了解 Ralph Loop 与 Stop Hook 的配合机制

### 2. 运行时文件遗留
- .prd.md, .dod.md, .quality-gate-passed 等文件被 git 追踪
- 每次测试后这些文件遗留在仓库中
- cleanup.sh 只删除 .quality-report.json，不删除其他运行时文件
- 影响后续测试和开发

### 3. 测试持续失败
- detect-priority.cjs 测试 'should return unknown when no priority found' 失败
- 原因：detect-priority 读取 git history，项目中有包含优先级关键字的 commit
- 测试环境无法隔离 git history

## 解决方案

### 1. 添加 Ralph Loop 使用文档
在 `skills/dev/SKILL.md` 中添加章节：
- 工作原理（Ralph Loop + Stop Hook 配合）
- P0 阶段使用（质检循环）
- P1 阶段使用（CI 修复循环）
- Stop Hook 配合机制
- 优势说明
- 典型使用场景

### 2. 修复运行时文件问题
- `.gitignore`: 添加运行时文件忽略规则
- `git rm --cached`: 移除现有文件的 git 追踪
- `cleanup.sh`: 扩展清理逻辑，删除所有运行时文件

### 3. 修复测试失败
- `detect-priority.cjs`: 添加 SKIP_GIT_DETECTION 环境变量
- 测试中设置该变量，跳过 git history 检测
- 不影响生产环境

## 涉及文件

- `skills/dev/SKILL.md` - 添加 Ralph Loop 章节
- `.gitignore` - 添加运行时文件
- `skills/dev/scripts/cleanup.sh` - 扩展清理逻辑
- `scripts/devgate/detect-priority.cjs` - 添加环境变量支持
- `tests/hooks/pr-gate-phase1.test.ts` - 修复测试

## 成功标准

- [ ] Ralph Loop 使用文档完整且准确
- [ ] 所有运行时文件已从 git 追踪中移除
- [ ] .gitignore 包含所有运行时文件
- [ ] cleanup.sh 清理所有运行时文件
- [ ] 所有测试通过 (186/186)
- [ ] CI 通过
