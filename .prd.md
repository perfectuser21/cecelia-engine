# PRD - 修复两阶段分离的矛盾实现

## 背景

当前代码存在严重的概念矛盾：

1. **文档声称"两阶段分离"**，但实际实现是"while true 轮询循环"（一次性跑完）
2. **09-ci.md** 把"事件驱动"标记为 ❌ 旧模式，把"轮询循环"标记为 ✅ 新模式
3. **Stop Hook** 设计支持事件驱动（push 后退出），但文档要求轮询循环（不退出）

**矛盾点**：
- "轮询循环" = 一直等待 CI，不退出会话
- "两阶段分离" = push 后退出，等下次唤醒
- **这两个概念是完全矛盾的！**

## 正确的设计应该是

**两阶段分离 + 事件驱动**：

```
p0: 质检 → 创建 PR → 结束（不等 CI）
p1: 修复 CI → push → 结束（不等 CI 结果，等下次唤醒）
```

**关键**：p1 阶段 push 后立即退出，不挂着等待 CI，由外部事件（CI 失败通知）触发下次会话。

## 功能描述

### 1. 修复 SKILL.md

- 移除 "P1 轮询循环" 相关描述
- 明确 p1 是"事件驱动循环"，不是"轮询循环"
- 更新流程图：p1 修复 → push → 退出 → 等唤醒

### 2. 修复 09-ci.md

- 移除 while true 轮询循环代码
- 恢复事件驱动模式（标记为 ✅ 正确模式）
- 明确 p1 行为：拉取失败详情 → 分析 → 修复 → push → 退出

### 3. 修复 Stop Hook (hooks/stop.sh)

- p1 阶段逻辑保持不变（已经是正确的）：
  - CI fail → exit 2（继续修）
  - CI pending → exit 0（退出，等唤醒）
  - CI pass → exit 0（结束）

### 4. 修复 detect-phase.sh

- p1 阶段描述改为"事件驱动循环"
- 移除 "无限循环修到绿" 等误导性描述

## 成功标准

1. 文档一致性：所有文件都描述"事件驱动 + 两阶段分离"
2. p0 阶段：创建 PR 后立即结束
3. p1 阶段：修复 → push → 退出（不挂着等 CI）
4. 没有 while true 循环
5. Stop Hook 正确执行阶段检查

## 非功能需求

- 保持向后兼容（Stop Hook 行为不变）
- 清晰的文档说明事件驱动模式

## 范围

只修改文档和流程描述，Stop Hook 代码基本不变（已经是正确的实现）。
