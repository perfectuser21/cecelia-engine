# PRD - Step 11 Cleanup 完善（验证机制）

## 需求来源
深度检查发现 Step 11 Cleanup 缺少关键验证机制，可能导致：
1. .dev-mode 被删除但实际未清理干净
2. 步骤未全部完成就标记为 done
3. gate 文件验证缺失
4. cleanup_done 标记不一致

## 功能描述
为 Step 11 Cleanup 添加验证机制，确保清理质量：

1. **删除前验证所有步骤完成**
   - 在删除 .dev-mode 前，检查 step_1 到 step_11 是否都标记为 done
   - 如果有任何步骤未完成，报错并阻止删除

2. **删除后验证文件不存在**
   - 删除 .dev-mode 后，验证文件确实不存在
   - 如果仍存在，报错

3. **验证必需的 gate 文件存在**
   - 在清理前，验证 .gate-prd-passed, .gate-dod-passed, .gate-audit-passed, .gate-test-passed 都存在
   - 如果缺失，警告（测试任务可能不需要所有 gate）

4. **统一 cleanup 标记方式**
   - 将 cleanup.sh 中的 `cleanup_done: true` 改为 `step_11_cleanup: done`
   - 与 Stop Hook 的检查逻辑保持一致

## 涉及文件
- `skills/dev/scripts/cleanup.sh` - 添加验证逻辑，修改标记方式
- `hooks/stop.sh` - 确认向后兼容（保留 cleanup_done 检查）
- `skills/dev/steps/11-cleanup.md` - 更新文档说明新增的验证

## 成功标准
1. **验证逻辑正确**
   - cleanup.sh 在删除 .dev-mode 前检查所有 step_N: done
   - 如果有步骤未完成，输出错误信息并 exit 1

2. **删除验证有效**
   - 删除 .dev-mode 后，检查文件是否存在
   - 如果仍存在，输出错误信息并 exit 1

3. **gate 文件检查**
   - 清理前检查必需的 gate 文件
   - 缺失时输出警告（不阻塞）

4. **标记统一**
   - cleanup.sh 使用 `sed -i 's/^step_11_cleanup: pending/step_11_cleanup: done/' .dev-mode`
   - Stop Hook 优先检查 step_11_cleanup: done，向后兼容 cleanup_done: true

5. **测试验证**
   - 所有步骤完成 → cleanup 成功
   - 有步骤未完成 → cleanup 报错
   - .dev-mode 删除失败 → cleanup 报错

## 非目标
- ❌ 不添加 gate:cleanup Subagent（这是 P2，本次只做 P1）
- ❌ 不修改 Self-Evolution 机制（这是 P3）
- ❌ 不改变 cleanup.sh 的其他清理逻辑

## 技术细节
### 验证所有步骤完成的逻辑
```bash
# 在删除 .dev-mode 前
if [[ -f "$DEV_MODE_FILE" ]]; then
    INCOMPLETE_STEPS=""
    for step in {1..11}; do
        STEP_STATUS=$(grep "^step_${step}_" "$DEV_MODE_FILE" 2>/dev/null | cut -d':' -f2 | xargs || echo "")
        if [[ "$STEP_STATUS" != "done" ]]; then
            INCOMPLETE_STEPS="$INCOMPLETE_STEPS step_$step"
        fi
    done

    if [[ -n "$INCOMPLETE_STEPS" ]]; then
        echo -e "${RED}[FAIL] 不能删除 .dev-mode，以下步骤未完成: $INCOMPLETE_STEPS${NC}"
        exit 1
    fi
fi
```

### 删除验证逻辑
```bash
# 删除 .dev-mode
rm -f "$DEV_MODE_FILE"

# 验证删除成功
if [[ -f "$DEV_MODE_FILE" ]]; then
    echo -e "${RED}[FAIL] .dev-mode 删除失败，文件仍存在${NC}"
    exit 1
fi
```

### 统一标记方式
```bash
# 旧方式（删除）
# echo "cleanup_done: true" >> "$DEV_MODE_FILE"

# 新方式（统一）
sed -i 's/^step_11_cleanup: pending/step_11_cleanup: done/' "$DEV_MODE_FILE"
```
