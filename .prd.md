---
id: prd-fix-ralph-loop-architecture
version: 1.0.0
created: 2026-01-28
updated: 2026-01-28
changelog:
  - 1.0.0: 初始版本
---

# PRD: 修复 Ralph Loop 架构问题

## 背景

`dev-with-loop` bash 脚本试图调用 `/ralph-loop`，但这是一个 Claude Code plugin 命令，**无法从 shell 调用**。导致 Ralph Loop 实际上从未运行过。

## 问题分析

| 问题 | 原因 |
|------|------|
| dev-with-loop 无法工作 | `/ralph-loop` 是 plugin 命令，只能在 Claude Code 会话内使用 |
| detect-phase.sh 已废弃 | /dev v2.2.0 删除了阶段检测，不再分 p0/p1/p2 |
| 文档引用过时 | CLAUDE.md 还在推荐 `dev-with-loop` 命令 |
| hooks/stop.sh 残留 | 文件已禁用但未删除 |

## 目标

1. 清理无法工作的脚本
2. 更新文档，指导用户正确使用 Ralph Loop
3. 保持架构一致性（/dev v2.2.0 统一流程）

## 验收标准

### AC1: 删除废弃脚本
- [ ] 删除 `/home/xx/bin/dev-with-loop`
- [ ] 删除 `scripts/detect-phase.sh`（如存在）
- [ ] 删除 `hooks/stop.sh`（已禁用但文件残留）

### AC2: 更新全局 CLAUDE.md
- [ ] 修改 `~/.claude/CLAUDE.md` 的 "Ralph Loop 使用规则" 章节
- [ ] 移除 `dev-with-loop` 命令引用
- [ ] 添加正确的 `/ralph-loop` 使用方式（在 Claude Code 会话内输入）

### AC3: 清理项目文档
- [ ] 检查并更新 Engine 中引用废弃脚本的文档

## 技术方案

### 新的 Ralph Loop 使用方式

```bash
# 在 Claude Code 会话里直接输入（不是 shell 命令）：
/ralph-loop "/dev .prd.md" --completion-promise "DONE" --max-iterations 20
```

### 简化后的流程

```
用户写 PRD → 进入 Claude Code → 输入 /ralph-loop 命令 → 自动开发
```

不再需要 wrapper 脚本，直接使用 plugin 命令。

## 不做什么

- 不修改 Ralph Loop plugin 本身（那是官方维护的）
- 不修改 /dev Skill 核心逻辑
