# DoD: P0 质检强制三件套

QA: docs/QA-DECISION.md

---

## 验收标准

### P0-1: Impact Check（能力变更强制登记）

**CI Job 实现**
- [x] CI job `impact-check` 添加到 `.github/workflows/ci.yml`
      Test: manual:p0-1-trigger
- [x] Job 使用 `scripts/devgate/impact-check.sh` 脚本
      Test: manual:p0-1-trigger

**脚本实现**
- [x] `scripts/devgate/impact-check.sh` 创建并可执行
      Test: manual:p0-1-trigger
- [x] 检测核心能力文件改动（hooks/, skills/, scripts/, features/）
      Test: manual:p0-1-trigger
- [x] 验证 `features/feature-registry.yml` 是否同时改动
      Test: manual:p0-1-fail
- [x] 前向一致性：改能力→必须登记
      Test: manual:p0-1-fail
- [x] 前向一致性：只改登记→允许（不要求改能力）
      Test: manual:p0-1-doc-only

**Feature Registry**
- [x] `features/feature-registry.yml` 创建
      Test: manual:p0-1-pass
- [x] 填充所有现有能力（从 FEATURES.md 迁移核心能力）
      Test: manual:p0-1-pass
- [x] 包含能力 ID、名称、文件路径、版本、描述
      Test: manual:p0-1-pass

**测试验证**
- [x] **测试**：改 `hooks/` 不改 `registry` → CI **FAIL**
      Test: manual:p0-1-fail
- [x] **测试**：改 `hooks/` 同时改 `registry` → CI **PASS**
      Test: manual:p0-1-pass
- [x] **测试**：只改 `registry` → CI **PASS**
      Test: manual:p0-1-doc-only

---

### P0-2: Evidence Gate（质检证据门控）

**证据生成**
- [x] `scripts/qa-with-gate.sh` 末尾生成 `.quality-evidence.json`
      Test: manual:p0-2-generate
- [x] 证据文件包含必需字段（sha, branch, qa_gate_passed, audit_decision）
      Test: manual:p0-2-generate
- [x] SHA 字段自动获取当前 HEAD（`git rev-parse HEAD`）
      Test: manual:p0-2-generate
- [x] Timestamp 字段自动生成（ISO 8601 格式）
      Test: manual:p0-2-generate

**CI Job 实现**
- [x] CI job `evidence-gate` 添加到 `.github/workflows/ci.yml`
      Test: manual:p0-2-missing
- [x] Job 验证证据文件存在
      Test: manual:p0-2-missing
- [x] Job 验证 JSON 字段齐全（sha, branch, qa_gate_passed, audit_decision）
      Test: manual:p0-2-missing
- [x] Job 验证 `sha == HEAD`（防老文件冒用） ⚠️ **关键**
      Test: manual:p0-2-sha
- [x] Job 验证 `qa_gate_passed == true`
      Test: manual:p0-2-missing
- [x] Job 验证 `audit_decision == "PASS"`
      Test: manual:p0-2-missing

**Git 配置**
- [x] `.gitignore` 允许 `.quality-evidence.json` 提交（不忽略）
      Test: manual:p0-2-generate

**测试验证**
- [x] **测试**：无证据文件 → CI **FAIL**
      Test: manual:p0-2-missing
- [x] **测试**：JSON 字段不全 → CI **FAIL**
      Test: manual:p0-2-missing
- [x] **测试**：SHA 不匹配 HEAD → CI **FAIL**
      Test: manual:p0-2-sha
- [x] **测试**：证据完整 → CI **PASS**
      Test: manual:p0-2-generate

---

### P0-3: Anti-Bypass 口径（远端强制兜底）

**契约文档**
- [x] `docs/contracts/QUALITY-CONTRACT.md` 创建
      Test: manual:p0-3-doc
- [x] 包含核心原则："本地 Hooks = 加速失败 / 远端 CI + Branch Protection = 最终强制"
      Test: manual:p0-3-doc
- [x] 包含本地 vs 远端职责映射表
      Test: manual:p0-3-doc
- [x] 说明 Branch Protection 配置要求
      Test: manual:p0-3-doc
- [x] 说明为什么不追求"本地 100% 封堵"
      Test: manual:p0-3-doc

**Branch Protection 配置**
- [x] 验证 main/develop 分支 Branch Protection 启用
      Test: manual:p0-3-doc
- [x] Required checks 包含 `impact-check`
      Test: manual:p0-3-doc
- [x] Required checks 包含 `evidence-gate`
      Test: manual:p0-3-doc
- [x] `enforce_admins: true` - Admin 也必须遵守
      Test: manual:p0-3-doc

**测试验证**
- [x] **审查**：QUALITY-CONTRACT.md 内容完整性
      Test: manual:p0-3-doc
- [x] **审查**：职责映射表清晰准确
      Test: manual:p0-3-doc
- [x] **验证**：GitHub Branch Protection 配置正确
      Test: manual:p0-3-doc

---

### 质量门控

**代码审计**
- [x] `/audit` 审计通过（Decision: PASS）
      Test: manual:audit-pass
- [x] L1/L2 问题已清零
      Test: manual:audit-pass

**测试通过**
- [x] `npm run qa:gate` 全部通过
      Test: contract:C2-001
- [x] `.quality-evidence.json` 生成成功
      Test: manual:p0-2-generate

**产物完整**
- [x] PRD (.prd.md) 存在且内容有效
      Test: manual:artifacts-check
- [x] DoD (.dod.md) 存在且内容有效
      Test: manual:artifacts-check
- [x] QA Decision (docs/QA-DECISION.md) 存在
      Test: manual:artifacts-check
- [x] Audit Report (docs/AUDIT-REPORT.md) 存在且 PASS
      Test: manual:artifacts-check

---

## 完成定义

满足以下所有条件即视为完成：

1. ✅ 所有验收清单项勾选
2. ✅ P0-1: Impact Check CI job 工作正常
3. ✅ P0-2: Evidence Gate CI job 工作正常
4. ✅ P0-3: Anti-Bypass 文档完整
5. ✅ 手动测试全部通过
6. ✅ 质量门控全部通过
7. ✅ PR 创建成功
