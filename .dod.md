# DoD - Step 11 Cleanup 完善（验证机制）

QA: docs/QA-DECISION-W8-cleanup-validation.md

## 验收标准

### 功能验收

#### 1. 删除前验证所有步骤完成
- [ ] cleanup.sh 在删除 .dev-mode 前检查 step_1 到 step_11 是否都是 done
      Test: tests/scripts/cleanup-validation.test.ts + contract:C7-001
- [ ] 有步骤未完成时，输出错误信息并 exit 1
      Test: tests/scripts/cleanup-validation.test.ts

#### 2. 删除后验证文件不存在
- [ ] cleanup.sh 删除 .dev-mode 后，验证文件确实不存在
      Test: tests/scripts/cleanup-validation.test.ts + contract:C7-002
- [ ] 文件仍存在时，输出错误信息并 exit 1
      Test: tests/scripts/cleanup-validation.test.ts

#### 3. 验证必需的 gate 文件存在
- [ ] cleanup.sh 在清理前检查 .gate-prd-passed, .gate-dod-passed, .gate-audit-passed, .gate-test-passed 是否存在
      Test: tests/scripts/cleanup-validation.test.ts
- [ ] gate 文件缺失时，输出警告（不阻塞）
      Test: tests/scripts/cleanup-validation.test.ts

#### 4. 统一 cleanup 标记方式
- [ ] cleanup.sh 使用 `sed -i 's/^step_11_cleanup: pending/step_11_cleanup: done/' .dev-mode`
      Test: tests/scripts/cleanup-validation.test.ts + contract:C7-003
- [ ] Stop Hook 优先检查 step_11_cleanup: done，向后兼容 cleanup_done: true
      Test: tests/hooks/stop-hook.test.ts + contract:H7-002 (已有，需更新)

### 测试验证

- [ ] 所有步骤完成 → cleanup 成功
      Test: tests/scripts/cleanup-validation.test.ts
- [ ] 有步骤未完成 → cleanup 报错
      Test: tests/scripts/cleanup-validation.test.ts
- [ ] .dev-mode 删除失败 → cleanup 报错
      Test: tests/scripts/cleanup-validation.test.ts

### 文档更新

- [ ] skills/dev/steps/11-cleanup.md 更新说明新增的验证逻辑
      Test: manual:文档检查

## 实现细节参考

PRD 中的技术细节已提供了验证逻辑、删除验证逻辑和统一标记方式的代码示例。
