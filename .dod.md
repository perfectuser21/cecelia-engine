# DoD: Ralph Loop 迭代追踪机制

QA: docs/QA-DECISION.md

## 验收清单

### 核心功能
- [ ] `scripts/ralph-tracker.sh` 工具实现并可执行
  Test: manual:tracker-executable
- [ ] `init` 命令：创建追踪文件
  Test: manual:tracker-init
- [ ] `record` 命令：记录迭代信息
  Test: manual:tracker-record
- [ ] `report` 命令：生成完整报告
  Test: manual:tracker-report
- [ ] `.ralph-loop-tracking.json` 格式正确
  Test: manual:tracking-format
- [ ] 包含 project, branch, start_time 字段
  Test: manual:tracking-fields
- [ ] iterations 数组支持增量追加
  Test: manual:tracking-append
- [ ] total_iterations 自动计数
  Test: manual:tracking-count

### Stop Hook 集成
- [ ] `hooks/stop.sh` 在每次触发时调用 ralph-tracker
  Test: manual:stop-hook-integration
- [ ] 记录所有 exit 2 的失败原因
  Test: manual:stop-hook-exit2
- [ ] Step 7.1: Audit 报告缺失
  Test: manual:stop-hook-audit-missing
- [ ] Step 7.2: Audit Decision 不是 PASS
  Test: manual:stop-hook-audit-fail
- [ ] Step 7.3: 质检未通过
  Test: manual:stop-hook-quality-fail
- [ ] Step 7.3: 时效性检查失败
  Test: manual:stop-hook-stale
- [ ] Step 8: PR 未创建
  Test: manual:stop-hook-pr-missing
- [ ] Step 9: CI 失败
  Test: manual:stop-hook-ci-fail
- [ ] Stop Hook 输出显示当前迭代编号
  Test: manual:stop-hook-iteration-display
- [ ] Exit 0 时生成最终报告
  Test: manual:stop-hook-final-report
- [ ] 归档追踪文件到 `.archive/ralph-loops/`
  Test: manual:stop-hook-archive

### CI 集成
- [ ] `.github/workflows/test.yml` 添加 Ralph Loop 统计步骤
  Test: manual:ci-workflow-step
- [ ] CI summary 显示总迭代次数
  Test: manual:ci-iteration-count
- [ ] CI summary 显示迭代历史列表
  Test: manual:ci-iteration-history

### 测试
- [ ] 手动测试：创建会触发多次迭代的场景
  Test: manual:multi-iteration-test
- [ ] 第 1 次：Audit 失败 → exit 2
  Test: manual:iteration-1-audit-fail
- [ ] 第 2 次：测试失败 → exit 2
  Test: manual:iteration-2-test-fail
- [ ] 第 3 次：全部通过 → exit 0
  Test: manual:iteration-3-success
- [ ] 验证 `.ralph-loop-tracking.json` 内容正确
  Test: manual:verify-tracking-file
- [ ] 验证 Stop Hook 输出显示迭代信息
  Test: manual:verify-stop-hook-output
- [ ] 验证最终报告内容完整
  Test: manual:verify-final-report
- [ ] 验证归档文件生成
  Test: manual:verify-archive

### 文档
- [ ] 创建 `docs/RALPH-LOOP-TRACKING.md`
  Test: manual:doc-created
- [ ] 功能说明
  Test: manual:doc-features
- [ ] 使用示例
  Test: manual:doc-examples
- [ ] 输出格式说明
  Test: manual:doc-format
- [ ] 更新 `CHANGELOG.md`
  Test: manual:changelog-updated
- [ ] 更新版本号（feat: minor）
  Test: manual:version-bump

### QA 决策
参考: skills/qa/SKILL.md

测试策略：
- **无需新增单元测试**（Hook 脚本，手动测试充分）
- **手动测试**：模拟多次 ralph-loop 迭代
- **回归测试**：确保现有 Stop Hook 逻辑不受影响

### 质量门控
- [ ] `/audit` 审计通过（Decision: PASS）
  Test: manual:audit-pass
- [ ] `npm run qa:gate` 全部通过
  Test: manual:qa-gate-pass
- [ ] `.quality-gate-passed` 文件生成
  Test: manual:quality-gate-file

## 完成定义

满足以下所有条件即视为完成：

1. ✅ 所有验收清单项勾选
2. ✅ Ralph tracker 脚本正常工作
3. ✅ Stop Hook 正确追踪和显示迭代
4. ✅ CI 正确显示统计
5. ✅ 手动测试通过
6. ✅ 质量门控全部通过
7. ✅ PR 创建成功
