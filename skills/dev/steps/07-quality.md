# Step 7: 三层质检

> 跑测试、看效果、对清单

**前置条件**：step >= 6
**完成后设置状态**：
```bash
git config branch."$BRANCH_NAME".step 7
```

---

## 三层质检体系

质检分三层，逐层验证，任何一层失败立即返回 Step 4 重新开始（5→6→7 循环）。

```
Layer 1: 跑测试 (自动化验证)
   ↓
Layer 2: 看效果 (实际效果验证)
   ↓
Layer 3: 对清单 (DoD 完成度验证)
```

---

## 7.1 跑测试 (Layer 1)

运行完整测试套件，必须全绿。

```bash
npm test
```

**人话解释**：
- **typecheck** (类型检查) - 检查代码有没有写错类型
- **lint** (代码风格) - 检查代码格式是否规范
- **test** (单元测试) - 检查功能是否正常

**结果判定**：
- ✅ 全绿 → 进入 Layer 2
- ❌ 有红 → 返回 Step 4 重新开始

---

## 7.2 看效果 (Layer 2)

根据改动类型，实际验证效果。

### 前端改动

使用 Chrome DevTools MCP 验证：

```bash
# 1. 打开对应页面
mcp navigate_page <URL>

# 2. 截图确认效果
mcp take_screenshot

# 3. 检查控制台报错
mcp list_console_messages
```

**检查点**：
- [ ] UI 显示正常（截图确认）
- [ ] 交互功能正常（点击、输入等）
- [ ] 无控制台报错

### API 改动

使用 curl 验证：

```bash
# 发送请求
curl -X POST http://localhost:3000/api/xxx \
  -H "Content-Type: application/json" \
  -d '{"key": "value"}'

# 检查响应
# - 状态码是否正确
# - 返回数据格式是否符合预期
# - 错误处理是否正常
```

**检查点**：
- [ ] API 响应正确
- [ ] 数据格式符合预期
- [ ] 错误处理正常

### 工具/脚本改动

实际运行验证：

```bash
# 运行脚本
bash scripts/xxx.sh

# 或
node src/xxx.js
```

**检查点**：
- [ ] 脚本执行成功
- [ ] 输出结果正确
- [ ] 无报错或警告

**结果判定**：
- ✅ 效果符合预期 → 进入 Layer 3
- ❌ 效果不对 → 返回 Step 4 重新开始

---

## 7.3 对清单 (Layer 3)

对照 DoD (Definition of Done) 清单，逐项确认。

### 查看 DoD 清单

```bash
# 从 git config 读取 DoD
git config branch."$BRANCH_NAME".dod
```

### 逐项确认

**示例 DoD**：
```
□ 用户可以在登录页输入账号密码
□ 点击登录后显示加载状态
□ 登录成功跳转到首页
□ 登录失败显示错误提示
□ 测试覆盖率 > 80%
```

**确认方式**：
- 必要项 (□) 必须全部完成
- 可选项 (○) 可以部分完成
- 每一项都要实际验证，不能只看代码

**结果判定**：
- ✅ 必要项全部完成 → Step 7 完成
- ❌ 任何必要项未完成 → 返回 Step 4 重新开始

---

## 结果处理

| 结果 | 动作 |
|------|------|
| ✅ 三层全过 | 继续下一步 (Step 8 - PR) |
| ❌ 任何失败 | 返回 Step 4 重新开始（5→6→7 循环）|

---

## 常见问题

**Q: Layer 1 测试全绿，但 Layer 2 效果不对？**
A: 说明测试覆盖不够，返回 Step 4 重新开始，补测试后再修。

**Q: Layer 3 发现 DoD 有遗漏项？**
A: 返回 Step 4 重新开始，补充功能后重新走一遍三层质检。

**Q: 前端改动如何快速验证？**
A: 优先用 Chrome DevTools MCP 截图，比人工打开浏览器快。

**Q: 能跳过 Layer 2 直接对清单吗？**
A: 不能。必须按顺序：测试 → 效果 → 清单。

---

## 质检原则

1. **逐层验证** - 不能跳过任何一层
2. **失败即止** - 任何一层失败立即返回 Step 4 重新开始（5→6→7 循环）
3. **实际验证** - 不能只看代码，要实际跑/看/点
4. **必要项清零** - DoD 必要项必须 100% 完成

---

## Hook 引导

PR Gate Hook 会自动运行 Layer 1 (npm test)，但 Layer 2 和 Layer 3 需要手动确认。

本地先完成三层质检，避免被 Hook 拦截。
