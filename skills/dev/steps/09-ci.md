# Step 9: CI 通过与自动合并

> 等待 CI 通过，自动合并；失败则回退修复

**前置条件**：step >= 8（PR 已创建）
**完成后设置状态**：
```bash
git config branch."$BRANCH_NAME".step 9
```

---

## CI 流程

```
PR 创建（Step 8）
    │
    ▼
┌─────────────────────────────────────┐
│  等待 CI：                          │
│    • version-check                  │
│    • test                           │
│    • shell scripts check            │
└─────────────────────────────────────┘
    │
    ├── CI 绿 → 自动合并 → step 9 → cleanup
    │
    └── CI 红 → 回退 step 4 → 修复 → 5→6→7 循环
```

---

## 使用轮询脚本

```bash
bash skills/dev/scripts/wait-for-merge.sh "$PR_URL"
```

**退出码**：
- `0` = PR 已合并
- `1` = 需要修复
- `2` = 超时

---

## CI 失败修复

```bash
# 1. 读取 CI 错误
gh run view --log-failed

# 2. 回退到 step 4（wait-for-merge.sh 会自动设置）
git config branch."$BRANCH_NAME".step 4

# 3. 修复代码

# 4. 重新走流程
# step 5 → 6 → 7 → 8 → 9（从 Step 5 开始）
```

---

## 自动合并逻辑

**CI 通过后自动合并**：
- GitHub Actions 检查全部通过
- 无需人工介入
- 合并后自动删除分支（由 CI 配置决定）

**注意**：
- CI 是唯一强制检查
- 不依赖任何人工 review
- 绿色即合并，红色即回退

---

## 注意

- **CI 绿是唯一完成标准**
- 失败后回退到 step 4（DoD 完成），从 Step 5 重新开始（5→6→7 循环）
- 不要手动合并，等待 CI 自动合并
